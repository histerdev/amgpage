---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Iniciar Sesión | AMG Sneakers">
  <main class="bg-[#0A0A0A] min-h-screen flex items-center justify-center px-6 py-24">
    <div class="w-full max-w-md">

      <!-- Logo -->
      <div class="text-center mb-10">
        <img src="/logo-amg-white.webp" alt="AMG Sneakers" class="h-10 w-auto mx-auto mb-6" width={960} height={960} />
        <h1 class="text-2xl font-bold text-[#F5F5F5] mb-2" style="font-family: 'Space Grotesk', sans-serif; letter-spacing: -0.02em;">
          Iniciar Sesión
        </h1>
        <p class="text-xs text-[#888888]">Accede a tu cuenta AMG</p>
      </div>

      <!-- Card -->
      <div class="bg-[#111111] border border-[#2A2A2A] rounded-sm p-8">

        <!-- Google -->
        <button
          id="google-btn"
          class="w-full flex items-center justify-center gap-3 border border-[#2A2A2A] hover:border-[#888888] bg-transparent text-[#F5F5F5] py-3.5 rounded-sm text-xs font-semibold uppercase tracking-widest transition-all duration-200 mb-6 cursor-pointer"
        >
          <svg width="18" height="18" viewBox="0 0 48 48">
            <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
            <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
            <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
            <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.31-8.16 2.31-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
          </svg>
          Continuar con Google
        </button>

        <!-- Separator -->
        <div class="flex items-center gap-4 mb-6">
          <div class="flex-1 h-px bg-[#2A2A2A]"></div>
          <span class="text-[10px] text-[#888888] uppercase tracking-widest">o</span>
          <div class="flex-1 h-px bg-[#2A2A2A]"></div>
        </div>

        <!-- Form -->
        <form id="login-form" class="space-y-4">
          <div>
            <label class="block text-[10px] font-semibold text-[#888888] uppercase tracking-widest mb-2">Email</label>
            <input
              type="email"
              name="email"
              required
              autocomplete="email"
              placeholder="tu@email.com"
              class="w-full bg-[#1A1A1A] border border-[#2A2A2A] focus:border-[#16A34A] rounded-sm py-3 px-4 text-sm text-[#F5F5F5] placeholder:text-[#888888] outline-none transition-colors"
            />
          </div>
          <div>
            <label class="block text-[10px] font-semibold text-[#888888] uppercase tracking-widest mb-2">Contraseña</label>
            <input
              type="password"
              name="password"
              required
              autocomplete="current-password"
              placeholder="••••••••"
              class="w-full bg-[#1A1A1A] border border-[#2A2A2A] focus:border-[#16A34A] rounded-sm py-3 px-4 text-sm text-[#F5F5F5] placeholder:text-[#888888] outline-none transition-colors"
            />
          </div>

          <div id="error-msg" class="hidden bg-red-900/20 border border-red-900/30 text-red-400 p-3 rounded-sm text-xs"></div>

          <button
            type="submit"
            id="submit-btn"
            class="w-full bg-[#16A34A] hover:bg-[#22C55E] text-black py-3.5 rounded-sm font-bold uppercase text-xs tracking-widest transition-all duration-200 cursor-pointer disabled:opacity-50 mt-2"
          >
            Entrar
          </button>
        </form>

        <!-- Register link -->
        <p class="text-center text-xs text-[#888888] mt-6">
          ¿No tienes cuenta?
          <a href="/registro" class="text-[#16A34A] hover:text-[#22C55E] font-semibold transition-colors ml-1">Crear cuenta</a>
        </p>
      </div>
    </div>
  </main>
</Layout>

<script>
  import { supabase } from '../lib/supabase';
  import { loginSchema } from '../utils/validation';

  const form      = document.getElementById('login-form') as HTMLFormElement;
  const errorMsg  = document.getElementById('error-msg') as HTMLDivElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  const googleBtn = document.getElementById('google-btn') as HTMLButtonElement;

  const params = new URLSearchParams(window.location.search);
  function safeRedirect(raw: string | null): string {
    if (!raw) return '/';
    if (!/^\/[^/]/.test(raw) && raw !== '/') return '/';
    return raw;
  }
  const redirectTo = safeRedirect(params.get('redirectTo'));

  googleBtn.addEventListener('click', async () => {
    googleBtn.disabled = true;
    googleBtn.textContent = 'Redirigiendo...';
    const { error } = await supabase.auth.signInWithOAuth({
      provider: 'google',
      options: { redirectTo: `${window.location.origin}/auth/callback?redirectTo=${encodeURIComponent(redirectTo)}` },
    });
    if (error) { googleBtn.disabled = false; googleBtn.textContent = 'Continuar con Google'; }
  });

  function showError(msg: string) {
    errorMsg.textContent = msg;
    errorMsg.classList.remove('hidden');
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    errorMsg.classList.add('hidden');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Verificando...';
    const data = new FormData(form);
    const email = (data.get('email') as string).trim().toLowerCase();
    const password = data.get('password') as string;
    try {
      const validated = loginSchema.parse({ email, password });
      const { error } = await supabase.auth.signInWithPassword(validated);
      if (error) {
        showError(error.message === 'Invalid login credentials' ? 'Email o contraseña incorrectos.' : error.message);
        return;
      }
      window.location.replace(redirectTo);
    } catch (err: any) {
      showError(err.errors?.[0]?.message ?? err?.message ?? 'Algo salió mal. Intenta de nuevo.');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Entrar';
    }
  });
</script>