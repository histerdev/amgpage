---
import Layout from '../../layouts/Layout.astro';
import SizeGuideModal from '../../components/SizeGuideModal.astro';
import TrustPaymentBlock from '../../components/TrustPaymentBlock.astro';
import ActivityToast from '../../components/ActivityToast.astro';
import QualityModal from '../../components/QualityModal.astro';
import SizeQuiz from '../../components/SizeQuiz.astro';
import { productos } from '../../data/products';

export const prerender = true;

export async function getStaticPaths() {
  const seen = new Set<string>();
  const uniqueProducts = productos.filter((p) => {
    if (seen.has(p.id)) return false;
    seen.add(p.id);
    return true;
  });
  return uniqueProducts.map((product) => ({
    params: { id: product.id.toString() },
    props: { product },
  }));
}

const { product } = Astro.props;
if (!product) return Astro.redirect('/404');

const initialImage = Array.isArray(product.image) ? product.image[0] : product.image;
const albumImages  = Array.isArray(product.image) ? product.image : [product.image];

const siteUrl = 'https://amgpage.vercel.app';
const lowestPrice  = Math.min(product.prices.PK, product.prices.G5);
const highestPrice = Math.max(product.prices.PK, product.prices.G5);
const formattedPK  = new Intl.NumberFormat('es-CL').format(product.prices.PK);
const formattedG5  = new Intl.NumberFormat('es-CL').format(product.prices.G5);

// Price anchoring ‚Äî retail reference is ~2.1√ó PK price (typical reseller markup)
const retailRef     = Math.round(product.prices.PK * 2.1 / 1000) * 1000;
const formattedRetail = new Intl.NumberFormat('es-CL').format(retailRef);
const savings       = retailRef - product.prices.PK;
const formattedSavings = new Intl.NumberFormat('es-CL').format(savings);
const savingsPct    = Math.round((savings / retailRef) * 100);

const productDescription = `${product.name} ‚Äî Disponible en calidad PK ($${formattedPK}) y G5 ($${formattedG5}). Inspecci√≥n QC real antes del env√≠o a todo Chile.`;

const whatsappNumber = import.meta.env.PUBLIC_WHATSAPP_NUMBER || '56912345678';
const whatsappMsg    = encodeURIComponent(`Hola AMG, tengo una pregunta sobre el ${product.name}`);

const productJsonLd = {
  '@context': 'https://schema.org',
  '@type': 'Product',
  name: product.name,
  image: albumImages.map((img: string) => `${siteUrl}${img}`),
  description: productDescription,
  brand: { '@type': 'Brand', name: 'AMG Sneakers' },
  offers: {
    '@type': 'AggregateOffer',
    lowPrice: lowestPrice,
    highPrice: highestPrice,
    priceCurrency: 'CLP',
    availability: 'https://schema.org/PreOrder',
    seller: { '@type': 'Organization', name: 'AMG Sneakers' },
  },
  url: `${siteUrl}/producto/${product.id}`,
};
---

<Layout
  title={product.name}
  description={productDescription}
  ogImage={initialImage}
  ogType="product"
  jsonLd={productJsonLd}
>
  <div class="bg-[#0A0A0A] pt-24 pb-20 min-h-screen">
    <div class="max-w-7xl mx-auto px-6">

      <!-- Breadcrumb -->
      <nav class="flex items-center gap-2 text-[10px] text-[#888888] uppercase tracking-widest mb-8" aria-label="Breadcrumb">
        <a href="/" class="hover:text-[#F5F5F5] transition-colors">Inicio</a>
        <span class="text-[#2A2A2A]">/</span>
        <a href="/coleccion" class="hover:text-[#F5F5F5] transition-colors">Colecci√≥n</a>
        <span class="text-[#2A2A2A]">/</span>
        <span class="text-[#F5F5F5] truncate max-w-[200px]">{product.name}</span>
      </nav>

      <!-- Main grid -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-10 lg:gap-16">

        <!-- ‚îÄ‚îÄ LEFT: Image gallery ‚îÄ‚îÄ -->
        <div class="reveal space-y-3">
          <!-- Main image -->
          <div class="bg-[#111111] border border-[#2A2A2A] rounded-sm aspect-square flex items-center justify-center overflow-hidden relative group">
            <img
              id="main-product-image"
              src={initialImage}
              alt={`${product.name} ‚Äî Sneaker AMG Sneakers Chile`}
              class="w-full h-full object-contain p-8 transition-transform duration-500 group-hover:scale-105"
              width={1280}
              height={1280}
            />
          </div>

          <!-- Thumbnails -->
          {albumImages.length > 1 && (
            <div class={`grid gap-2`} style={`grid-template-columns: repeat(${Math.min(albumImages.length, 6)}, 1fr);`}>
              {albumImages.map((img: string, idx: number) => (
                <button
                  class={`thumb-btn border rounded-sm aspect-square overflow-hidden bg-[#1A1A1A] transition-all duration-200 ${idx === 0 ? 'border-[#16A34A]' : 'border-[#2A2A2A] hover:border-[#888888]'}`}
                  data-src={img}
                  aria-label={`Vista ${idx + 1}`}
                >
                  <img
                    src={img}
                    alt={`${product.name} ‚Äî Vista ${idx + 1}`}
                    class="w-full h-full object-contain p-1"
                    width={200}
                    height={200}
                    loading="lazy"
                    decoding="async"
                  />
                </button>
              ))}
            </div>
          )}

          <!-- "How we verify quality" educational block -->
          <div class="bg-[#111111] border border-[#2A2A2A] rounded-sm p-5">
            <p class="text-[10px] font-bold text-[#888888] uppercase tracking-widest mb-3 flex items-center gap-2">
              <svg class="w-3.5 h-3.5 text-[#16A34A]" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.537 3.204a1 1 0 00-1.414-1.414l-3.293 3.293-1.293-1.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              ¬øC√≥mo verificamos la calidad?
            </p>
            <ul class="space-y-2">
              {[
                'Etiqueta interior y n√∫mero de lote verificados',
                'Simetr√≠a del logo y costuras inspeccionadas',
                'Reacci√≥n del material al doblado comprobada',
                'Peso del par completo validado contra referencia',
              ].map(item => (
                <li class="flex items-start gap-2 text-[11px] text-[#888888] leading-snug">
                  <svg class="w-3 h-3 text-[#16A34A] flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                  </svg>
                  {item}
                </li>
              ))}
            </ul>
          </div>

          <!-- Real QC Photos Section -->
          <div class="mt-4">
            <p class="text-[10px] font-bold text-[#F5F5F5] uppercase tracking-widest mb-3 flex items-center gap-2">
              <span class="text-xl">üì∏</span> As√≠ revisamos tu par antes de enviarlo ‚Üí
            </p>
            <div class="grid grid-cols-2 gap-2">
              {[1, 2, 3, 4].map((num) => (
                <div class="bg-[#111111] border border-[#2A2A2A] rounded-sm aspect-square relative flex flex-col items-center justify-center p-4 text-center overflow-hidden">
                  <svg class="w-6 h-6 text-[#2A2A2A] mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                  </svg>
                  <p class="text-[9px] text-[#555555] uppercase tracking-widest font-semibold">
                    {num === 1 ? 'Foto en caja' : num === 2 ? 'Etiqueta QC' : num === 3 ? 'Detalles HD' : 'Par embalado'}
                  </p>
                  <!-- 
                    TODO (AMG): Reemplazar por im√°genes reales usando la etiqueta img. 
                    Ejemplo: <img src={`/images/qc-real-${num}.jpg`} class="absolute inset-0 w-full h-full object-cover" />
                  -->
                </div>
              ))}
            </div>
          </div>
        </div>

        <!-- ‚îÄ‚îÄ RIGHT: Product details ‚îÄ‚îÄ -->
        <div class="reveal space-y-6"
          id="product-root"
          data-id={product.id}
          data-name={product.name}
          data-price-pk={product.prices.PK}
          data-price-g5={product.prices.G5}
          data-reveal-delay="120"
          data-reveal-direction="right"
        >

          <!-- Grade badge + quality modal trigger + wishlist heart -->
          <div class="flex items-center gap-3 flex-wrap">
            <span class="inline-block bg-[#16A34A] text-black text-[9px] font-bold uppercase tracking-widest px-3 py-1.5 rounded-full">
              GRADO PK
            </span>
            <QualityModal />
            <!-- Wishlist heart -->
            <button
              id="product-wishlist-btn"
              class="ml-auto flex items-center gap-1.5 px-3 py-1.5 border border-[#2A2A2A] rounded-sm text-[10px] text-[#888888] hover:border-red-400/60 hover:text-red-400 transition-all duration-200 bg-transparent cursor-pointer"
              data-product-id={product.id}
              data-product-name={product.name}
              data-product-image={initialImage}
              data-price-pk={product.prices.PK}
              data-price-g5={product.prices.G5}
              aria-label="Guardar par"
            >
              <!-- outline -->
              <svg id="pwl-outline" class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
              </svg>
              <!-- filled -->
              <svg id="pwl-filled" class="w-4 h-4 text-red-400 hidden" fill="currentColor" viewBox="0 0 24 24">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
              </svg>
              <span id="pwl-label">Guardar par</span>
            </button>
          </div>

          <!-- Product name -->
          <h1 class="text-3xl md:text-4xl font-bold text-[#F5F5F5] leading-tight" style="font-family: 'Space Grotesk', sans-serif; letter-spacing: -0.02em;">
            {product.name}
          </h1>

          <!-- Price anchoring block -->
          <div class="space-y-1">
            <!-- Retail reference (struck through) -->
            <div class="flex items-center gap-2">
              <span
                class="text-sm text-[#555555] line-through"
                title="Precio de referencia en tiendas oficiales y resellers Chile"
              >
                ${formattedRetail}
              </span>
              <span class="text-[9px] text-[#555555] uppercase tracking-wider">Retail ref.</span>
            </div>
            <!-- AMG price -->
            <div class="flex items-baseline gap-3">
              <span class="text-3xl font-bold text-[#16A34A]" id="display-price-formatted">
                ${formattedPK}
              </span>
              <span class="text-xs text-[#888888] uppercase tracking-wider">CLP</span>
            </div>
            <p class="text-[10px] text-[#888888] uppercase tracking-wider">Precio de Gesti√≥n</p>
            <!-- Savings badge -->
            <div class="inline-flex items-center gap-1.5 bg-[#0D1F10] border border-[#16A34A]/20 rounded-sm px-2.5 py-1 mt-1">
              <svg class="w-3 h-3 text-[#16A34A]" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03zM12.12 15.12A3 3 0 017 13s.879.5 2.5.5c0-1 .5-4 1.25-4.5.5 1 .786 1.293 1.371 1.879A2.99 2.99 0 0113 13a2.99 2.99 0 01-.879 2.121z" clip-rule="evenodd"/>
              </svg>
              <span class="text-[10px] font-bold text-[#16A34A]">
                Ahorro: ${formattedSavings} ({savingsPct}%)
              </span>
            </div>
          </div>

          <!-- Honest scarcity / Availability -->
          <div class="flex items-center gap-2 bg-[#111111] border border-[#2A2A2A] rounded-sm py-2 px-3 inline-flex">
            <span class="relative flex h-2 w-2">
              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-[#16A34A] opacity-75"></span>
              <span class="relative inline-flex rounded-full h-2 w-2 bg-[#16A34A]"></span>
            </span>
            <p class="text-[10.5px] font-semibold text-[#888888] uppercase tracking-wider">
              Disponibilidad sujeta a f√°brica ‚Äî Gesti√≥n individual
            </p>
          </div>

          <div class="border-t border-[#2A2A2A]"></div>

          <!-- Quality Selector -->
          <div class="space-y-3">
            <p class="text-[10px] font-bold text-[#888888] uppercase tracking-widest">Calidad de Gesti√≥n</p>
            <div class="flex gap-2">
              <button
                data-q="PK"
                class="q-selector flex-1 py-3 rounded-sm text-xs font-semibold uppercase tracking-wide border-2 transition-all duration-200 bg-[#16A34A] text-black border-[#16A34A]"
              >
                PK Industrial
              </button>
              <button
                data-q="G5"
                class="q-selector flex-1 py-3 rounded-sm text-xs font-semibold uppercase tracking-wide border-2 transition-all duration-200 bg-transparent text-[#888888] border-[#2A2A2A] hover:border-[#888888]"
              >
                G5 Est√°ndar
              </button>
            </div>
          </div>

          <!-- Size Selector -->
          <div class="space-y-3" id="size-section">
            <div class="flex justify-between items-center">
              <p class="text-[10px] font-bold text-[#888888] uppercase tracking-widest">Seleccionar Talla (EU)</p>
              <button
                id="open-size-guide-btn"
                class="text-[10px] text-[#16A34A] hover:text-[#22C55E] uppercase tracking-widest font-semibold cursor-pointer bg-transparent border-none transition-colors"
              >
                Gu√≠a de tallas
              </button>
            </div>
            
            <div class="grid grid-cols-5 gap-2">
              {product.tallas.map((talla: string) => {
                const cmMap: Record<string, string> = {
                  '36': '22.5cm', '37.5': '23.5cm', '38': '24cm', '39': '24.5cm',
                  '40': '25cm', '41': '26cm', '42': '26.5cm', '42.5': '27cm',
                  '43': '27.5cm', '44': '28cm', '44.5': '28.5cm', '45': '29cm',
                  '46': '30cm', '47.5': '31cm'
                };
                const cm = cmMap[talla] || '';
                return (
                  <button
                    data-size={talla}
                    class="s-selector py-2 flex flex-col items-center justify-center rounded-sm border border-[#2A2A2A] bg-transparent text-[#888888] hover:border-[#F5F5F5] hover:text-[#F5F5F5] transition-all duration-200"
                  >
                    <span class="text-xs font-semibold">{talla}</span>
                    <span class="text-[9px] opacity-70 mt-0.5">{cm || '-'}</span>
                  </button>
                );
              })}
            </div>

            <!-- Error message (hidden by default) -->
            <div id="size-error-msg" class="hidden bg-red-900/20 border border-red-500/50 text-red-400 text-xs p-3 rounded-sm">
              ‚ö†Ô∏è Selecciona tu talla para continuar
            </div>

            <!-- Size quiz widget -->
            <SizeQuiz />

            <p class="text-[10px] text-[#888888] leading-relaxed mt-2 bg-[#1A1A1A] p-2 rounded-sm border border-[#2A2A2A]">
              ‚ö†Ô∏è <strong class="text-[#F5F5F5]">Importante:</strong> Las tallas corresponden exactamente a las medidas oficiales de Nike/Jordan. Si normalmente usas 42 EU, pide el 42.
            </p>
          </div>

          <!-- Trust blocks moved above purchase buttons -->
          <TrustPaymentBlock />

          <div class="bg-[#111111] border border-[#2A2A2A] rounded-sm p-4 space-y-3">
            {[
              { icon: 'üõ°Ô∏è', label: 'Pago procesado 100% por MercadoPago' },
              { icon: 'üì∏', label: 'Recibir√°s QC visual antes del env√≠o' },
              { icon: '‚öñÔ∏è', label: 'Seguro de reposici√≥n aduanero incluido' },
            ].map(t => (
              <div class="flex items-center gap-3">
                <span class="text-base">{t.icon}</span>
                <p class="text-xs text-[#888888]">{t.label}</p>
              </div>
            ))}
          </div>

          <div class="bg-[#111111] border border-[#2A2A2A] rounded-sm p-4">
            <details class="group">
              <summary class="flex justify-between items-center font-bold text-xs text-[#F5F5F5] uppercase tracking-wider cursor-pointer list-none">
                <span class="flex items-center gap-2">‚öñÔ∏è ¬øY si aduana retiene el paquete?</span>
                <span class="transition group-open:rotate-180">
                  <svg fill="none" height="20" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="20"><path d="M6 9l6 6 6-6"></path></svg>
                </span>
              </summary>
              <p class="text-[#888888] text-xs mt-3 leading-relaxed">
                <strong class="text-[#16A34A]">Cubierto.</strong> Te mandamos otro sin costo ni tr√°mites de tu parte. El seguro de reposici√≥n cubre el 100% del env√≠o.
              </p>
            </details>
          </div>

          <!-- Add to Cart / Buy Now -->
          <div class="space-y-3 pt-1">
            <button
              id="add-to-cart-action"
              class="w-full h-14 bg-[#16A34A] hover:bg-[#22C55E] text-black font-bold uppercase text-xs tracking-widest transition-all duration-200 rounded-sm hover:scale-[1.01] active:scale-[0.99] flex items-center justify-center gap-2"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
              </svg>
              Agregar al carrito
            </button>
            <button
              id="buy-now-action"
              class="w-full h-12 bg-transparent border border-[#2A2A2A] hover:border-[#F5F5F5] text-[#F5F5F5] font-semibold text-xs uppercase tracking-widest transition-all duration-200 rounded-sm"
            >
              Comprar ahora ‚Üí
            </button>
          </div>

          <!-- WhatsApp consultation -->
          <a
            href={`https://wa.me/${whatsappNumber}?text=${whatsappMsg}`}
            target="_blank"
            rel="noopener noreferrer"
            class="flex items-center gap-2.5 text-xs text-[#888888] hover:text-[#F5F5F5] transition-colors"
          >
            <svg class="w-4 h-4 text-[#128C7E] flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
              <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
            </svg>
            ¬øTienes dudas? Preg√∫ntanos antes de comprar ‚Üí
          </a>

          <!-- Tags -->
          {product.tags.length > 0 && (
            <div class="flex flex-wrap gap-1.5 pt-1">
              {product.tags.map((tag: string) => (
                <span class="text-[9px] font-semibold text-[#888888] uppercase tracking-wider border border-[#2A2A2A] px-2.5 py-1 rounded-sm">
                  {tag}
                </span>
              ))}
            </div>
          )}

        </div>
      </div>
    </div>
  </div>

  <!-- Modals & toasts -->
  <SizeGuideModal />
  <ActivityToast productName={product.name} />

  <!-- ‚îÄ‚îÄ Sticky mobile CTA bar ‚îÄ‚îÄ -->
  <div
    id="sticky-mobile-bar"
    class="fixed bottom-0 left-0 right-0 z-40 bg-[#111111] border-t border-[#2A2A2A] px-4 py-3 flex items-center justify-between gap-3 lg:hidden translate-y-full transition-transform duration-300"
    style="padding-bottom: env(safe-area-inset-bottom, 12px);"
  >
    <div class="min-w-0">
      <p class="text-[10px] text-[#F5F5F5] font-semibold truncate">{product.name}</p>
      <p class="text-[10px] text-[#888888]">
        Talla: <span id="sticky-size-display">‚Äî</span>
      </p>
    </div>
    <div class="flex items-center gap-3 flex-shrink-0">
      <span class="text-sm font-bold text-[#16A34A]" id="sticky-price-display">${formattedPK}</span>
      <button
        id="sticky-add-to-cart"
        class="bg-[#16A34A] hover:bg-[#22C55E] text-black font-bold text-[10px] uppercase tracking-widest px-4 py-2.5 rounded-sm transition-colors whitespace-nowrap"
      >
        Pedir este par
      </button>
    </div>
  </div>

<script>
  import { addToCart } from '../../store/cartStore';
  import { isCartOpen } from '../../store/cartStore';
  import { wishlist, toggleWishlist, isWishlisted } from '../../store/wishlistStore';

  // ‚îÄ‚îÄ Wishlist heart (product page) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const pwlBtn     = document.getElementById('product-wishlist-btn') as HTMLElement | null;
  const pwlOutline = document.getElementById('pwl-outline') as SVGElement | null;
  const pwlFilled  = document.getElementById('pwl-filled') as SVGElement | null;
  const pwlLabel   = document.getElementById('pwl-label') as HTMLElement | null;

  function syncProductHeart() {
    if (!pwlBtn) return;
    const saved = isWishlisted(pwlBtn.dataset.productId!);
    pwlOutline?.classList.toggle('hidden', saved);
    pwlFilled?.classList.toggle('hidden', !saved);
    if (pwlLabel) pwlLabel.textContent = saved ? 'Guardado ‚ô•' : 'Guardar par';
    if (saved) {
      pwlBtn.classList.add('border-red-400/60', 'text-red-400');
      pwlBtn.classList.remove('border-[#2A2A2A]', 'text-[#888888]');
    } else {
      pwlBtn.classList.remove('border-red-400/60', 'text-red-400');
      pwlBtn.classList.add('border-[#2A2A2A]', 'text-[#888888]');
    }
  }

  syncProductHeart();
  wishlist.subscribe(() => syncProductHeart());
  window.addEventListener('wishlist-change', () => syncProductHeart());

  pwlBtn?.addEventListener('click', async () => {
    if (!pwlBtn) return;
    const item = {
      id: pwlBtn.dataset.productId!,
      name: pwlBtn.dataset.productName!,
      image: pwlBtn.dataset.productImage!,
      pricePK: Number(pwlBtn.dataset.pricePk),
      priceG5: Number(pwlBtn.dataset.priceG5),
      savedAt: Date.now(),
    };
    // Pulse animation
    pwlBtn.style.transform = 'scale(1.1)';
    setTimeout(() => { pwlBtn.style.transform = ''; }, 180);
    const nowSaved = await toggleWishlist(item);
    window.dispatchEvent(new CustomEvent('wishlist-change', { detail: { id: item.id, saved: nowSaved } }));
  });

  const root         = document.getElementById('product-root') as HTMLElement;
  const mainImg      = document.getElementById('main-product-image') as HTMLImageElement;
  const priceEl      = document.getElementById('display-price-formatted') as HTMLElement;
  const qButtons     = document.querySelectorAll('.q-selector');
  const sButtons     = document.querySelectorAll('.s-selector');
  const stickyBar    = document.getElementById('sticky-mobile-bar') as HTMLElement;
  const stickySize   = document.getElementById('sticky-size-display') as HTMLElement;
  const stickyPrice  = document.getElementById('sticky-price-display') as HTMLElement;
  const addCartBtn   = document.getElementById('add-to-cart-action') as HTMLElement;

  let selectedSize: string | null = null;
  let selectedQuality: 'PK' | 'G5' = 'PK';

  const prices: Record<string, number> = {
    PK: Number(root.dataset.pricePk),
    G5: Number(root.dataset.priceG5),
  };

  function formatPrice(n: number) {
    return new Intl.NumberFormat('es-CL').format(n);
  }

  // Quality selector
  qButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const quality = (btn as HTMLElement).dataset.q as 'PK' | 'G5';
      selectedQuality = quality;
      qButtons.forEach(b => {
        b.className = 'q-selector flex-1 py-3 rounded-sm text-xs font-semibold uppercase tracking-wide border-2 transition-all duration-200 bg-transparent text-[#888888] border-[#2A2A2A] hover:border-[#888888]';
      });
      btn.className = 'q-selector flex-1 py-3 rounded-sm text-xs font-semibold uppercase tracking-wide border-2 transition-all duration-200 bg-[#16A34A] text-black border-[#16A34A]';
      const p = formatPrice(prices[selectedQuality]);
      priceEl.textContent = `$${p}`;
      if (stickyPrice) stickyPrice.textContent = `$${p}`;
    });
  });

  // Size selector
  sButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      selectedSize = (btn as HTMLElement).dataset.size || null;
      sButtons.forEach(b => {
        b.className = 's-selector py-2 flex flex-col items-center justify-center rounded-sm border border-[#2A2A2A] bg-transparent text-[#888888] hover:border-[#F5F5F5] hover:text-[#F5F5F5] transition-all duration-200';
      });
      btn.className = 's-selector py-2 flex flex-col items-center justify-center rounded-sm border-2 border-[#16A34A] bg-[#16A34A] text-black transition-all duration-200';
      if (stickySize && selectedSize) stickySize.textContent = selectedSize;
    });
  });

  // Sticky mobile bar ‚Äî show when add-to-cart scrolls out of view
  if (stickyBar && addCartBtn) {
    const observer = new IntersectionObserver(
      ([entry]) => {
        const wpBtn = document.getElementById('whatsapp-float');
        if (!entry.isIntersecting) {
          stickyBar.style.transform = 'translateY(0)';
          if (wpBtn && window.innerWidth < 1024) {
            wpBtn.style.transform = 'translateY(-70px)';
            wpBtn.style.transition = 'transform 0.3s ease-out';
          }
        } else {
          stickyBar.style.transform = 'translateY(100%)';
          if (wpBtn) {
            wpBtn.style.transform = 'translateY(0)';
          }
        }
      },
      { threshold: 0 }
    );
    observer.observe(addCartBtn);
  }

  // Thumbnail gallery
  document.querySelectorAll('.thumb-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const src = (btn as HTMLElement).dataset.src;
      if (src && mainImg) {
        document.querySelectorAll('.thumb-btn').forEach(b => {
          b.className = b.className.replace('border-[#16A34A]', 'border-[#2A2A2A]');
        });
        btn.className = btn.className.replace('border-[#2A2A2A]', 'border-[#16A34A]').replace('hover:border-[#888888]', '');
      }
    });
  });

  // Size guide
  document.getElementById('open-size-guide-btn')?.addEventListener('click', () => {
    window.dispatchEvent(new CustomEvent('open-size-guide'));
  });

  // Purchase handler
  function handlePurchase(redirect: boolean = false) {
    if (!selectedSize) {
      const sizeError = document.getElementById('size-error-msg');
      const sizeSection = document.getElementById('size-section');
      if (sizeError && sizeSection) {
        sizeError.classList.remove('hidden');
        sizeError.classList.add('animate-[shake_0.5s_ease-in-out]');
        sizeSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setTimeout(() => {
          sizeError.classList.add('hidden');
          sizeError.classList.remove('animate-[shake_0.5s_ease-in-out]');
        }, 3000);
      }
      return;
    }
    const priceToPay = prices[selectedQuality];
    const productToSave = {
      id: `${root.dataset.id}-${selectedQuality}-${selectedSize}`,
      productId: root.dataset.id,
      name: root.dataset.name,
      image: mainImg.src,
      size: selectedSize,
      quality: selectedQuality,
      quantity: 1,
      price: priceToPay,
      prices: { [selectedQuality]: priceToPay },
    };
    addToCart(productToSave);
    if (redirect) {
      window.location.href = '/checkout';
    } else {
      isCartOpen.set(true);
    }
  }

  document.getElementById('add-to-cart-action')?.addEventListener('click', () => handlePurchase(false));
  document.getElementById('buy-now-action')?.addEventListener('click', () => handlePurchase(true));
  document.getElementById('sticky-add-to-cart')?.addEventListener('click', () => handlePurchase(false));

</script>
</Layout>