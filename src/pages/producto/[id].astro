---
import Layout from '../../layouts/Layout.astro';
import SizeGuideModal from '../../components/SizeGuideModal.astro';
import { productos } from '../../data/products';

export const prerender = true;

export async function getStaticPaths() {
  // Deduplicate by ID — in case of duplicates in products.ts
  const seen = new Set<string>();
  const uniqueProducts = productos.filter((p) => {
    if (seen.has(p.id)) return false;
    seen.add(p.id);
    return true;
  });

  return uniqueProducts.map((product) => ({
    params: { id: product.id.toString() },
    props: { product },
  }));
}

const { product } = Astro.props;

if (!product) return Astro.redirect('/404');

const initialImage = Array.isArray(product.image) ? product.image[0] : product.image;
const albumImages = Array.isArray(product.image) ? product.image : [product.image];

// ── SEO ─────────────────────────────────────────
const siteUrl = 'https://amgpage.vercel.app';

const lowestPrice = Math.min(product.prices.PK, product.prices.G5);
const highestPrice = Math.max(product.prices.PK, product.prices.G5);
const formattedPK = new Intl.NumberFormat('es-CL').format(product.prices.PK);
const formattedG5 = new Intl.NumberFormat('es-CL').format(product.prices.G5);

const productDescription = `${product.name} — Disponible en calidad PK ($${formattedPK}) y G5 ($${formattedG5}). Inspección QC real antes del envío a todo Chile.`;

const productJsonLd = {
  "@context": "https://schema.org",
  "@type": "Product",
  "name": product.name,
  "image": albumImages.map((img: string) => `${siteUrl}${img}`),
  "description": productDescription,
  "brand": {
    "@type": "Brand",
    "name": "AMG Sneakers"
  },
  "offers": {
    "@type": "AggregateOffer",
    "lowPrice": lowestPrice,
    "highPrice": highestPrice,
    "priceCurrency": "CLP",
    "availability": "https://schema.org/InStock",
    "seller": {
      "@type": "Organization",
      "name": "AMG Sneakers"
    }
  },
  "url": `${siteUrl}/producto/${product.id}`
};
---

<Layout 
  title={product.name}
  description={productDescription}
  ogImage={initialImage}
  ogType="product"
  jsonLd={productJsonLd}
>
  <main class="relative bg-white pt-32 pb-20">
    <div class="max-w-7xl mx-auto px-6 grid grid-cols-1 md:grid-cols-2 gap-16">
      
      <!-- ── GALERÍA DE IMÁGENES ── -->
      <div class="space-y-4">
        <div class="bg-[#f9f9f9] rounded-[40px] aspect-square flex items-center justify-center border border-gray-100 overflow-hidden">
          <img 
            id="main-product-image" 
            src={initialImage} 
            alt={`${product.name} — Sneaker premium AMG Sneakers`}
            class="w-full h-full object-contain p-6"
            width={1280}
            height={1280}
          />
        </div>
        <div class="grid grid-cols-6 gap-2">
          {albumImages.map((img: string, idx: number) => (
            <button 
              class={`thumb-btn border-2 rounded-xl aspect-square overflow-hidden bg-[#f9f9f9] transition-all ${idx === 0 ? 'border-black' : 'border-gray-100'}`}
              data-src={img}
            >
              <img 
                src={img} 
                alt={`${product.name} — Vista ${idx + 1}`}
                class="w-full h-full object-contain"
                loading="lazy"
              />
            </button>
          ))}
        </div>
      </div>

      <!-- ── DETALLES DEL PRODUCTO ── -->
      <div class="space-y-8" 
           id="product-root" 
           data-id={product.id} 
           data-name={product.name} 
           data-price-pk={product.prices.PK} 
           data-price-g5={product.prices.G5}>
        
        <div>
          <h1 class="text-6xl font-[900] uppercase italic tracking-tighter text-slate-900 leading-none">{product.name}</h1>
          <p class="text-3xl font-light mt-4 italic text-gray-500">
            $ <span id="display-price">{formattedPK}</span> CLP
          </p>
        </div>

        <!-- Selector de Calidad -->
        <div class="space-y-4">
          <p class="text-[10px] font-black uppercase text-gray-400">Calidad de Gestión:</p>
          <div class="flex gap-3">
            <button data-q="PK" class="q-selector flex-1 bg-black text-white py-4 rounded-xl font-black text-[11px] border-2 border-black italic transition-all">
              PK INDUSTRIAL (TOP)
            </button>
            <button data-q="G5" class="q-selector flex-1 bg-white text-gray-400 py-4 rounded-xl font-black text-[11px] border-2 border-gray-100 italic transition-all">
              G5 STANDARD
            </button>
          </div>
        </div>

        <!-- Selector de Talla -->
        <div class="space-y-4">
          <div class="flex justify-between items-center">
            <p class="text-[10px] font-black uppercase text-gray-400">Talla EU:</p>
            <button id="open-size-guide-btn" class="text-[9px] font-black text-[#2ecc71] uppercase cursor-pointer bg-transparent border-none">Guía de tallas</button>
          </div>
          <div class="grid grid-cols-5 gap-2">
            {product.tallas.map((talla: string) => (
              <button data-size={talla} class="s-selector border-2 border-gray-100 py-3 rounded-xl font-black text-xs italic bg-white text-black hover:border-black transition-all">
                {talla}
              </button>
            ))}
          </div>
        </div>

        <!-- Botones de Acción -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-4">
          <button id="add-to-cart-action" class="bg-white text-black border-2 border-black py-6 rounded-2xl font-black uppercase text-[10px] tracking-widest hover:bg-gray-50 transition-all">
            Añadir al Carrito
          </button>
          <button id="buy-now-action" class="bg-black text-white py-6 rounded-2xl font-black uppercase text-[10px] tracking-widest shadow-2xl hover:bg-[#2ecc71] transition-all">
            Comprar Ahora
          </button>
        </div>
      </div>
    </div>
  </main>

  <SizeGuideModal />

<script>
  import { addToCart } from '../../store/cartStore';

  const root = document.getElementById('product-root') as HTMLElement;
  const displayPrice = document.getElementById('display-price') as HTMLElement;
  const mainImg = document.getElementById('main-product-image') as HTMLImageElement;
  const qButtons = document.querySelectorAll('.q-selector');
  const sButtons = document.querySelectorAll('.s-selector');

  let selectedSize: string | null = null;
  let selectedQuality: 'PK' | 'G5' = 'PK';

  const prices: Record<string, number> = {
    PK: Number(root.dataset.pricePk),
    G5: Number(root.dataset.priceG5)
  };

  // ✅ SELECTOR DE CALIDAD
  qButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const quality = (btn as HTMLElement).dataset.q as 'PK' | 'G5';
      selectedQuality = quality;
      qButtons.forEach(b => b.className = 'q-selector flex-1 bg-white text-gray-400 py-4 rounded-xl font-black text-[11px] border-2 border-gray-100 italic transition-all');
      btn.className = 'q-selector flex-1 bg-black text-white py-4 rounded-xl font-black text-[11px] border-2 border-black italic transition-all';
      displayPrice.innerText = new Intl.NumberFormat('es-CL').format(prices[selectedQuality]);
    });
  });

  // ✅ SELECTOR DE TALLA
  sButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      selectedSize = (btn as HTMLElement).dataset.size || null;
      sButtons.forEach(b => b.classList.remove('border-black', 'bg-black', 'text-white'));
      btn.classList.add('border-black', 'bg-black', 'text-white');
    });
  });

  // ✅ THUMBNAIL GALLERY — cambiar imagen principal al click
  document.querySelectorAll('.thumb-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const src = (btn as HTMLElement).dataset.src;
      if (src && mainImg) {
        mainImg.src = src;
        document.querySelectorAll('.thumb-btn').forEach(b => {
          b.classList.remove('border-black');
          b.classList.add('border-gray-100');
        });
        btn.classList.remove('border-gray-100');
        btn.classList.add('border-black');
      }
    });
  });

  // ✅ GUÍA DE TALLAS — botón sin inline onclick
  document.getElementById('open-size-guide-btn')?.addEventListener('click', () => {
    window.dispatchEvent(new CustomEvent('open-size-guide'));
  });

  // ✅ COMPRA / CARRITO
  function handlePurchase(redirect: boolean = false) {
    if (!selectedSize) {
      alert('POR FAVOR SELECCIONA TU TALLA');
      return;
    }

    const priceToPay = prices[selectedQuality];

    const productToSave = {
      id: `${root.dataset.id}-${selectedQuality}-${selectedSize}`,
      productId: root.dataset.id,
      name: root.dataset.name,
      image: mainImg.src,
      size: selectedSize,
      quality: selectedQuality,
      quantity: 1,
      price: priceToPay,
      prices: {
        [selectedQuality]: priceToPay
      }
    };

    addToCart(productToSave);
    
    if (redirect) {
      window.location.href = '/checkout';
    } else {
      window.dispatchEvent(new CustomEvent('open-cart'));
    }
  }

  document.getElementById('add-to-cart-action')?.addEventListener('click', () => handlePurchase(false));
  document.getElementById('buy-now-action')?.addEventListener('click', () => handlePurchase(true));
</script>
</Layout>