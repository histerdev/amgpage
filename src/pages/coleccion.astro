---
import Layout from '../layouts/Layout.astro';
import ProductCard from '../components/ProductCard.astro';
import { productos } from '../data/products';
export const prerender = true;

const siluetas = ["Jordan 1", "Jordan 3", "Jordan 4", "Jordan 5", "Jordan 6", "Jordan 7", "Jordan 8", "Jordan 9", "Jordan 11", "Jordan 12", "Jordan 13", "Dunk", "Travis Scott"];
const todosLosTags = [...new Set(productos.flatMap(p => p.tags))].sort();

// First 8 products get eager loading + high fetchpriority (LCP candidates)
const EAGER_COUNT = 8;
---

<Layout
  title="Catálogo | AMG Sneakers"
  description="Catálogo completo de AMG Sneakers Chile. Pares premium calidad PK y G5. Filtro por silueta, color y colaboración."
>
  <main class="bg-[#0A0A0A] pt-24 pb-20 min-h-screen">
    <div id="catalog-container" class="max-w-7xl mx-auto px-4 md:px-6">

      <!-- Header -->
      <div class="mb-12">
        <div class="flex items-baseline gap-4 mb-8">
          <h1 class="text-5xl md:text-7xl font-bold text-[#F5F5F5]" style="font-family: 'Space Grotesk', sans-serif; letter-spacing: -0.04em;">
            Catálogo
          </h1>
          <span class="text-xs font-semibold bg-[#16A34A] text-black px-3 py-1 rounded-full uppercase tracking-widest">
            {productos.length} pares
          </span>
        </div>

        <!-- Filter bar — backdrop-blur only on desktop (GPU-heavy on mobile) -->
        <div class="sticky top-[80px] z-40 bg-[#0A0A0A]/95 md:backdrop-blur-md pb-4 space-y-3">

          <!-- Search -->
          <div class="relative">
            <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-[#888888]" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.8">
              <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
            <input
              type="text"
              id="search-input"
              placeholder="Buscar por nombre o color..."
              class="w-full bg-[#111111] border border-[#2A2A2A] focus:border-[#16A34A] rounded-sm pl-11 pr-4 py-3.5 outline-none text-xs text-[#F5F5F5] placeholder:text-[#888888] uppercase tracking-wider transition-colors"
            />
          </div>

          <!-- Silhouette buttons -->
          <div class="flex overflow-x-auto gap-2 pb-1 no-scrollbar">
            <button class="silhouette-btn flex-shrink-0 px-4 py-2 rounded-sm text-[10px] font-semibold uppercase tracking-widest whitespace-nowrap transition-all duration-200 bg-[#16A34A] text-black border border-[#16A34A]" data-filter="all">
              Todos
            </button>
            {siluetas.map(s => (
              <button class="silhouette-btn flex-shrink-0 px-4 py-2 rounded-sm text-[10px] font-semibold uppercase tracking-widest whitespace-nowrap transition-all duration-200 bg-transparent text-[#888888] border border-[#2A2A2A] hover:border-[#888888] hover:text-[#F5F5F5]" data-filter={s.toLowerCase()}>
                {s}
              </button>
            ))}
          </div>

          <!-- Advanced filters toggle -->
          <div>
            <button id="toggle-advanced" class="flex items-center gap-2 text-[10px] text-[#888888] hover:text-[#16A34A] uppercase tracking-widest font-semibold transition-colors cursor-pointer bg-transparent border-none">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
              </svg>
              Filtros avanzados
            </button>
          </div>

        </div>

        <!-- Advanced panel -->
        <div id="advanced-panel" class="hidden bg-[#111111] border border-[#2A2A2A] rounded-sm p-4 mb-6">
          <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2">
            {todosLosTags.map(tag => (
              <label class="flex items-center gap-2 p-2.5 bg-[#1A1A1A] border border-[#2A2A2A] hover:border-[#16A34A] rounded-sm cursor-pointer transition-colors">
                <input type="checkbox" class="tag-checkbox w-3.5 h-3.5 accent-[#16A34A]" value={tag.toLowerCase()} />
                <span class="text-[9px] font-semibold uppercase tracking-wider text-[#888888]">{tag}</span>
              </label>
            ))}
          </div>
        </div>
      </div>

      <!-- Product grid — all products rendered (SSG), JS hides invisible ones -->
      <div id="product-grid" class="grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
        {productos.map((prod, i) => (
          <div
            class="product-wrapper"
            data-product-id={prod.id}
            data-index={i}
          >
            <ProductCard {...prod} eager={i < EAGER_COUNT} />
          </div>
        ))}
      </div>

      <!-- No results -->
      <div id="no-results" class="hidden text-center py-32">
        <p class="text-[#888888] text-sm mb-2">Sin resultados para tu búsqueda.</p>
        <p class="text-[10px] text-[#888888] uppercase tracking-widest">Intenta con otro término.</p>
      </div>

    </div>
  </main>
</Layout>

<style>
  .no-scrollbar::-webkit-scrollbar { display: none; }
  .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
</style>

<script>
  const searchInput     = document.getElementById('search-input') as HTMLInputElement;
  const silhouetteBtns  = document.querySelectorAll('.silhouette-btn');
  const tagCheckboxes   = document.querySelectorAll('.tag-checkbox');
  const toggleAdvanced  = document.getElementById('toggle-advanced');
  const advancedPanel   = document.getElementById('advanced-panel');
  const noResults       = document.getElementById('no-results');

  const productWrappers = Array.from(document.querySelectorAll('.product-wrapper')) as HTMLElement[];
  const products = productWrappers.map(wrapper => {
    const card = wrapper.querySelector('.product-item') as HTMLElement | null;
    return { wrapper, name: card?.dataset.name || '', tags: (card?.dataset.tags || '').split('|').filter(Boolean) };
  });

  let currentSilhouette = 'all';
  let selectedTags: string[] = [];
  let currentSearch = '';
  let filterRaf = 0;

  function applyFilters() {
    let count = 0;
    const q = currentSearch.toLowerCase();
    products.forEach(({ wrapper, name, tags }) => {
      const ok =
        name.includes(q) &&
        (currentSilhouette === 'all' || tags.some(t => t === currentSilhouette || t.startsWith(currentSilhouette + ' '))) &&
        (selectedTags.length === 0 || selectedTags.every(st => tags.includes(st)));
      wrapper.hidden = !ok;
      if (ok) count++;
    });
    noResults?.classList.toggle('hidden', count > 0);
  }

  function schedule() {
    if (filterRaf) cancelAnimationFrame(filterRaf);
    filterRaf = requestAnimationFrame(() => { filterRaf = 0; applyFilters(); });
  }

  toggleAdvanced?.addEventListener('click', () => advancedPanel?.classList.toggle('hidden'));

  silhouetteBtns.forEach(btn => btn.addEventListener('click', () => {
    silhouetteBtns.forEach(b => {
      b.className = 'silhouette-btn flex-shrink-0 px-4 py-2 rounded-sm text-[10px] font-semibold uppercase tracking-widest whitespace-nowrap transition-all duration-200 bg-transparent text-[#888888] border border-[#2A2A2A] hover:border-[#888888] hover:text-[#F5F5F5]';
    });
    btn.className = 'silhouette-btn flex-shrink-0 px-4 py-2 rounded-sm text-[10px] font-semibold uppercase tracking-widest whitespace-nowrap transition-all duration-200 bg-[#16A34A] text-black border border-[#16A34A]';
    currentSilhouette = (btn as HTMLElement).dataset.filter || 'all';
    schedule();
  }));

  tagCheckboxes.forEach(cb => cb.addEventListener('change', () => {
    selectedTags = Array.from(tagCheckboxes).filter(i => (i as HTMLInputElement).checked).map(i => (i as HTMLInputElement).value);
    schedule();
  }));

  searchInput?.addEventListener('input', e => {
    currentSearch = (e.target as HTMLInputElement).value;
    schedule();
  });
</script>

<!-- Wishlist script — SINGLE instance, not per-card, to avoid N syncAllHearts() calls -->
<script>
  import { wishlist, toggleWishlist, isWishlisted } from '../store/wishlistStore';

  function syncAllHearts() {
    document.querySelectorAll<HTMLElement>('.wishlist-heart-btn').forEach(btn => {
      const id = btn.dataset.productId!;
      const saved = isWishlisted(id);
      btn.querySelector('.heart-outline')?.classList.toggle('hidden', saved);
      btn.querySelector('.heart-filled')?.classList.toggle('hidden', !saved);
    });
  }

  // Initial sync — single pass over all cards
  syncAllHearts();

  // Re-sync when wishlist state changes
  wishlist.subscribe(() => syncAllHearts());
  window.addEventListener('wishlist-change', () => syncAllHearts());

  // Unified click delegation — one listener for ALL cards in the page
  document.addEventListener('click', async (e) => {
    const btn = (e.target as HTMLElement).closest<HTMLElement>('.wishlist-heart-btn');
    if (!btn) return;
    e.preventDefault();
    e.stopPropagation();

    const id      = btn.dataset.productId!;
    const name    = btn.dataset.productName!;
    const image   = btn.dataset.productImage!;
    const pricePK = Number(btn.dataset.pricePk);
    const priceG5 = Number(btn.dataset.priceG5);

    // Optimistic animation
    btn.style.transform = 'scale(1.25)';
    setTimeout(() => { btn.style.transform = ''; }, 200);

    const nowSaved = await toggleWishlist({ id, name, image, pricePK, priceG5, savedAt: Date.now() });

    btn.querySelector('.heart-outline')?.classList.toggle('hidden', nowSaved);
    btn.querySelector('.heart-filled')?.classList.toggle('hidden', !nowSaved);

    showWishlistToast(nowSaved, name);
    window.dispatchEvent(new CustomEvent('wishlist-change', { detail: { id, saved: nowSaved } }));
  });

  function showWishlistToast(saved: boolean, name: string) {
    const existing = document.getElementById('wl-toast');
    existing?.remove();

    const toast = document.createElement('div');
    toast.id = 'wl-toast';
    toast.className = 'fixed bottom-[80px] left-4 z-[200] flex items-center gap-2.5 bg-[#1A1A1A] border border-[#2A2A2A] rounded-sm px-4 py-3 shadow-2xl max-w-[280px]';
    toast.style.cssText = 'opacity:0; transform:translateX(-16px); transition: opacity 0.3s ease, transform 0.3s ease;';

    const shortName = name.length > 28 ? name.slice(0, 28) + '…' : name;
    toast.innerHTML = saved
      ? `<svg class="w-4 h-4 text-red-400 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg><div><p class="text-[11px] text-[#F5F5F5] font-semibold">${shortName}</p><a href="/guardados" class="text-[10px] text-[#16A34A] hover:underline">Ver guardados →</a></div>`
      : `<svg class="w-4 h-4 text-[#888888] flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg><p class="text-[11px] text-[#888888]">Quitado de guardados</p>`;

    document.body.appendChild(toast);
    requestAnimationFrame(() => requestAnimationFrame(() => {
      toast.style.opacity = '1';
      toast.style.transform = 'translateX(0)';
    }));
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateX(-16px)';
      setTimeout(() => toast.remove(), 350);
    }, 3500);
  }
</script>