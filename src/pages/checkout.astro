---
import Layout from '../layouts/Layout.astro';
import RegionesYComunas from '../data/chile';

export const prerender = false;
---

<Layout title="Checkout | Finalizar Compra">
    
    <main class="max-w-5xl mx-auto px-6 py-12 font-['Inter',_sans-serif]">
        <div class="mb-12 text-center md:text-left">
            <h1 class="text-3xl md:text-5xl font-[900] uppercase italic tracking-tighter mb-2">
                Checkout Seguro
            </h1>
            <div class="flex items-center gap-2 justify-center md:justify-start text-green-600 text-xs font-bold uppercase tracking-widest">
                <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                Conexión Encriptada SSL
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
            
            <div class="lg:col-span-7">
                <form id="checkout-form" class="space-y-6">
                    
                    <div class="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm">
                        <h3 class="text-xs font-black uppercase text-gray-400 tracking-widest mb-6">Datos del Cliente</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" name="primer_nombre" placeholder="NOMBRE" required class="input-amg" />
                            <input type="text" name="apellido_paterno" placeholder="APELLIDO" required class="input-amg" />
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <input type="text" name="rut" placeholder="RUT (12345678-K)" required class="input-amg" />
                            <input type="email" name="email" placeholder="EMAIL DE CONTACTO" required class="input-amg" />
                        </div>
                        <div class="mt-4">
                             <input type="tel" name="telefono" placeholder="TELÉFONO (+569...)" required class="input-amg" />
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm">
                        <h3 class="text-xs font-black uppercase text-gray-400 tracking-widest mb-6">Dirección de Envío</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <select id="region-select" name="region" required class="input-amg bg-transparent">
                                <option value="" disabled selected>SELECCIONAR REGIÓN</option>
                                {RegionesYComunas.map((reg) => (
                                    <option value={reg.name}>{reg.name}</option>
                                ))}
                            </select>

                            <select id="ciudad-select" name="ciudad" required disabled class="input-amg bg-transparent disabled:opacity-50">
                                <option value="" disabled selected>SELECCIONAR COMUNA</option>
                            </select>
                        </div>
                        <input type="text" name="direccion" placeholder="CALLE, NÚMERO, DEPTO" required class="input-amg" />
                    </div>

                    <div id="error-message" class="hidden bg-red-50 text-red-600 p-4 rounded-xl text-xs font-bold text-center border border-red-100"></div>

                    <button type="submit" id="pay-button" class="w-full bg-black text-white py-6 rounded-[20px] font-[900] uppercase italic tracking-widest text-sm hover:scale-[1.01] hover:bg-zinc-800 transition-all shadow-xl disabled:opacity-70 disabled:cursor-not-allowed">
                        Ir a Pagar
                    </button>
                    <p class="text-[10px] text-center text-gray-400 mt-4 font-bold uppercase">Procesado por Mercado Pago</p>
                </form>
            </div>

            <div class="lg:col-span-5">
                <div class="bg-zinc-50 p-6 rounded-[40px] border border-zinc-200 lg:sticky lg:top-24">
                    <h3 class="text-xs font-black uppercase text-gray-400 tracking-widest mb-6 text-center">Tu Pedido</h3>
                    
                    <div id="checkout-products-list" class="space-y-4 mb-8 max-h-[400px] overflow-y-auto custom-scrollbar">
                        </div>

                    <div class="border-t border-dashed border-gray-300 pt-6">
                        <div class="flex justify-between items-end">
                            <span class="text-xs font-bold text-gray-400 uppercase tracking-widest">Total a Pagar</span>
                            <span id="sum-price" class="text-4xl font-[900] italic tracking-tighter text-black">$0</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>
</Layout>

<style>
    .input-amg {
        width: 100%;
        border: none;
        border-bottom: 2px solid #f3f4f6;
        padding: 12px 0;
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        outline: none;
        transition: all 0.3s;
    }
    .input-amg:focus {
        border-bottom-color: black;
    }
</style>
<script>
    import { supabase } from '../lib/supabase';
    import RegionesYComunas from '../data/chile';
    import { cartItems } from '../store/cartStore';

    // ELEMENTOS DEL DOM
    const listContainer = document.getElementById('checkout-products-list');
    const totalEl = document.getElementById('sum-price');
    const form = document.getElementById('checkout-form') as HTMLFormElement;
    const payBtn = document.getElementById('pay-button') as HTMLButtonElement;
    const errorMsg = document.getElementById('error-message');
    const regionSelect = document.getElementById('region-select') as HTMLSelectElement;
    const ciudadSelect = document.getElementById('ciudad-select') as HTMLSelectElement;
    const rutInput = form?.querySelector('input[name="rut"]') as HTMLInputElement;
    const telefonoInput = form?.querySelector('input[name="telefono"]') as HTMLInputElement;

    // ✅ SANITIZAR HTML para prevenir XSS
    function escapeHTML(str: string): string {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    // ✅ FORMATEADOR DE RUT (EN TIEMPO REAL)
    function formatRUT(value: string): string {
        const clean = value.replace(/[^0-9K]/gi, '').toUpperCase();
        
        if (clean.length === 0) return '';
        
        const dv = clean.slice(-1);
        const nums = clean.slice(0, -1);
        
        let formatted = '';
        const numReverse = nums.split('').reverse().join('');
        
        for (let i = 0; i < numReverse.length; i++) {
            if (i > 0 && i % 3 === 0) {
                formatted = '.' + formatted;
            }
            formatted = numReverse[i] + formatted;
        }
        
        return formatted + '-' + dv;
    }

    // ✅ FORMATEADOR DE TELÉFONO CHILENO (EN TIEMPO REAL)
    function formatPhone(value: string): string {
        let clean = value.replace(/\D/g, '');
        
        if (clean.startsWith('56')) {
            clean = clean.slice(2);
        }
        
        if (clean.startsWith('0')) {
            clean = clean.slice(1);
        }
        
        clean = clean.slice(-9);
        
        if (clean.length === 0 || !clean.startsWith('9')) {
            return value;
        }
        
        return `+56${clean}`;
    }

    // ✅ LISTENER PARA AUTO-FORMATEAR RUT AL ESCRIBIR
    if (rutInput) {
        rutInput.addEventListener('input', (e) => {
            const target = e.target as HTMLInputElement;
            const value = target.value;
            
            let clean = value.replace(/[^0-9K]/gi, '').toUpperCase();
            
            clean = clean.slice(0, 9);
            
            if (clean.length > 0) {
                const dv = clean.slice(-1);
                const nums = clean.slice(0, -1);
                
                let formatted = '';
                const numReverse = nums.split('').reverse().join('');
                
                for (let i = 0; i < numReverse.length; i++) {
                    if (i > 0 && i % 3 === 0) {
                        formatted = '.' + formatted;
                    }
                    formatted = numReverse[i] + formatted;
                }
                
                target.value = formatted + (dv ? '-' + dv : '');
            }
        });
    }

    // ✅ LISTENER PARA AUTO-FORMATEAR TELÉFONO AL ESCRIBIR
    if (telefonoInput) {
        telefonoInput.addEventListener('input', (e) => {
            const target = e.target as HTMLInputElement;
            const value = target.value;
            
            let clean = value.replace(/\D/g, '');
            
            clean = clean.slice(0, 15);
            
            if (clean.startsWith('56')) {
                clean = clean.slice(2);
            }
            
            if (clean.startsWith('0')) {
                clean = clean.slice(1);
            }
            
            clean = clean.slice(-9);
            
            if (clean.length > 0 && clean.startsWith('9')) {
                target.value = `+56${clean}`;
            } else if (clean.length > 0) {
                target.value = clean;
            }
        });
    }

    // 1. RENDERIZADO DEL CARRITO (✅ SANITIZADO contra XSS)
    (cartItems as any).subscribe((items: any[]) => {
        if (!listContainer || !totalEl) return;

        if (items.length === 0) {
            listContainer.innerHTML = `<p class="text-center text-xs font-bold text-gray-400 py-10">CARRITO VACÍO</p>`;
            totalEl.innerText = '$0';
            if (payBtn) payBtn.disabled = true;
            return;
        }

        if (payBtn) payBtn.disabled = false;

        listContainer.innerHTML = items.map((item: any) => {
            const nombre = escapeHTML(item.name || item.product_name || 'PRODUCTO');
            const imagen = escapeHTML(item.image || item.image_url || '/placeholder.jpg');
            const talla = escapeHTML(String(item.size || 'N/A'));
            const precio = Number(item.price) || 0;
            const cantidad = Number(item.quantity) || 1;

            return `
                <div class="flex gap-4 bg-white p-3 rounded-2xl border border-gray-100 items-center">
                    <img src="${imagen}" class="w-14 h-14 object-contain rounded-lg bg-gray-50" />
                    <div class="flex-1 min-w-0">
                        <p class="font-black text-[10px] uppercase truncate">${nombre}</p>
                        <p class="text-[9px] font-bold text-gray-400">Talla: ${talla}</p>
                    </div>
                    <p class="font-black text-xs">$${(precio * cantidad).toLocaleString('es-CL')}</p>
                </div>
            `;
        }).join('');

        const total = items.reduce((acc: number, item: any) => acc + ((Number(item.price) || 0) * (Number(item.quantity) || 1)), 0);
        totalEl.innerText = `$${total.toLocaleString('es-CL')}`;
    });

    // 2. MANEJO DEL SUBMIT (PAGO)
    form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        payBtn.disabled = true;
        payBtn.innerHTML = "Procesando...";
        if (errorMsg) errorMsg.classList.add('hidden');

        try {
            const formData = new FormData(form);
            const currentItems = (cartItems as any).get();
            
            if (!currentItems || currentItems.length === 0) {
                throw new Error('Carrito vacío');
            }

            const { data: { session } } = await supabase.auth.getSession();
            const userId = session?.user?.id || null;

            // ✅ FORMATEAR DATOS ANTES DE ENVIAR
            const rut = (formData.get('rut') as string).trim();
            const phone = (formData.get('telefono') as string).trim();
            const formattedRut = formatRUT(rut);
            const formattedPhone = formatPhone(phone);

            const payload = {
                items: currentItems,
                customer: {
                    userId: userId,
                    firstName: (formData.get('primer_nombre') as string).trim(),
                    lastName: (formData.get('apellido_paterno') as string).trim(),
                    email: (formData.get('email') as string).trim().toLowerCase(),
                    rut: formattedRut,
                    phone: formattedPhone,
                    region: formData.get('region') as string,
                    city: formData.get('ciudad') as string,
                    address: (formData.get('direccion') as string).trim()
                }
            };

            // Llamar al endpoint
            const response = await fetch('/api/create-payment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (!response.ok) {
                // ✅ MANEJAR 429 (Too Many Requests)
                if (response.status === 429) {
                    const retryAfter = response.headers.get('Retry-After') || result.retryAfter;
                    const minutes = Math.ceil(retryAfter / 60);
                    throw new Error(`Demasiados intentos. Espera ${minutes} minutos e intenta de nuevo.`);
                }
                
                throw new Error(result.error || `Error ${response.status}`);
            }

            if (!result.init_point) {
                throw new Error("No se pudo generar el enlace de pago");
            }

            // ✅ Limpiar carrito y redirigir
            (cartItems as any).set([]);
            localStorage.removeItem('amg-cart');
            
            window.location.href = result.init_point;

        } catch (err: unknown) {
            const message = err instanceof Error ? err.message : 'Error desconocido';
            console.error('❌ Error checkout:', message);
            if (errorMsg) {
                errorMsg.innerText = `⚠️ ${message}`;
                errorMsg.classList.remove('hidden');
            }
        } finally {
            payBtn.disabled = false;
            payBtn.innerHTML = "Ir a Pagar";
        }
    });

    // 3. LÓGICA DE REGIONES
    regionSelect?.addEventListener('change', () => {
        const reg = RegionesYComunas.find(r => r.name === regionSelect.value);
        if (ciudadSelect && reg) {
            ciudadSelect.innerHTML = '<option value="" disabled selected>SELECCIONAR COMUNA</option>';
            ciudadSelect.disabled = false;
            reg.communes.sort().forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.textContent = c;
                ciudadSelect.appendChild(opt);
            });
        }
    });
</script>