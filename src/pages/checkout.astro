---
import Layout from '../layouts/Layout.astro';
import RegionesYComunas from '../data/chile';

export const prerender = false;
---

<Layout title="Checkout | Finalizar Gesti√≥n | AMG Sneakers">
  <main class="bg-[#0A0A0A] pt-24 pb-20 min-h-screen">
    <div class="max-w-5xl mx-auto px-6">

      <!-- Header -->
      <div class="mb-10">
        <p class="text-[10px] font-bold text-[#16A34A] uppercase tracking-[0.3em] mb-2">Paso final</p>
        <h1 class="text-3xl md:text-4xl font-bold text-[#F5F5F5]" style="font-family: 'Space Grotesk', sans-serif; letter-spacing: -0.02em;">
          Finalizar Gesti√≥n
        </h1>
        <div class="flex items-center gap-2 mt-2">
          <span class="w-1.5 h-1.5 rounded-full bg-[#16A34A] animate-pulse"></span>
          <span class="text-[10px] text-[#888888] uppercase tracking-widest font-semibold">Conexi√≥n encriptada SSL ¬∑ MercadoPago</span>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">

        <!-- LEFT: Form -->
        <div class="lg:col-span-7">
          <form id="checkout-form" class="space-y-4">

            <!-- Customer data -->
            <div class="bg-[#111111] border border-[#2A2A2A] rounded-sm p-6">
              <h3 class="text-[10px] font-bold uppercase tracking-widest text-[#888888] mb-5">Datos del Cliente</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-[9px] font-semibold text-[#888888] uppercase tracking-widest mb-1.5">Nombre</label>
                  <input type="text" name="primer_nombre" placeholder="Tu nombre" required class="input-amg" />
                </div>
                <div>
                  <label class="block text-[9px] font-semibold text-[#888888] uppercase tracking-widest mb-1.5">Apellido</label>
                  <input type="text" name="apellido_paterno" placeholder="Tu apellido" required class="input-amg" />
                </div>
                <div>
                  <label class="block text-[9px] font-semibold text-[#888888] uppercase tracking-widest mb-1.5">RUT</label>
                  <input type="text" name="rut" placeholder="12.345.678-K" required class="input-amg" />
                </div>
                <div>
                  <label class="block text-[9px] font-semibold text-[#888888] uppercase tracking-widest mb-1.5">Email</label>
                  <input type="email" name="email" placeholder="tu@email.com" required class="input-amg" />
                </div>
              </div>
              <div class="mt-4">
                <label class="block text-[9px] font-semibold text-[#888888] uppercase tracking-widest mb-1.5">Tel√©fono</label>
                <input type="tel" name="telefono" placeholder="+569..." required class="input-amg" />
              </div>
            </div>

            <!-- Shipping address -->
            <div class="bg-[#111111] border border-[#2A2A2A] rounded-sm p-6">
              <h3 class="text-[10px] font-bold uppercase tracking-widest text-[#888888] mb-5">Direcci√≥n de Env√≠o</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                  <label class="block text-[9px] font-semibold text-[#888888] uppercase tracking-widest mb-1.5">Regi√≥n</label>
                  <select id="region-select" name="region" required class="input-amg cursor-pointer">
                    <option value="" disabled selected>Seleccionar regi√≥n</option>
                    {RegionesYComunas.map((reg) => (
                      <option value={reg.name}>{reg.name}</option>
                    ))}
                  </select>
                </div>
                <div>
                  <label class="block text-[9px] font-semibold text-[#888888] uppercase tracking-widest mb-1.5">Comuna</label>
                  <select id="ciudad-select" name="ciudad" required disabled class="input-amg cursor-pointer disabled:opacity-40 disabled:cursor-not-allowed">
                    <option value="" disabled selected>Seleccionar comuna</option>
                  </select>
                </div>
              </div>
              <div>
                <label class="block text-[9px] font-semibold text-[#888888] uppercase tracking-widest mb-1.5">Direcci√≥n</label>
                <input type="text" name="direccion" placeholder="Calle, n√∫mero, depto" required class="input-amg" />
              </div>
            </div>

            <!-- Error -->
            <div id="error-message" class="hidden bg-red-900/20 border border-red-900/30 text-red-400 p-4 rounded-sm text-xs font-semibold"></div>

            <!-- Submit -->
            <button
              type="submit"
              id="pay-button"
              class="w-full bg-[#16A34A] hover:bg-[#22C55E] text-black py-5 rounded-sm font-bold uppercase tracking-widest text-sm transition-all duration-200 hover:scale-[1.01] active:scale-[0.99] cursor-pointer disabled:opacity-60 disabled:cursor-not-allowed"
            >
              Pagar de forma segura en MercadoPago üîí
            </button>
            <p class="text-[10px] text-center text-[#888888] uppercase tracking-widest">
              Pago procesado de forma segura por MercadoPago
            </p>

          </form>
        </div>

        <!-- RIGHT: Order summary -->
        <div class="lg:col-span-5">
          <div class="bg-[#111111] border border-[#2A2A2A] rounded-sm p-6 lg:sticky lg:top-24">
            <h3 class="text-[10px] font-bold uppercase tracking-widest text-[#888888] mb-5">Tu Pedido</h3>

            <div id="checkout-products-list" class="space-y-3 mb-6 max-h-[360px] overflow-y-auto">
              <!-- Populated by JS -->
            </div>

            <!-- Totals -->
            <div class="border-t border-[#2A2A2A] pt-4 space-y-2">
              <div class="flex justify-between text-xs text-[#888888]">
                <span>Log√≠stica incluida</span>
                <span class="text-[#16A34A] font-semibold">Gratis ‚úì</span>
              </div>
              <div class="flex justify-between items-end pt-2">
                <span class="text-xs font-semibold text-[#888888] uppercase tracking-wider">Total</span>
                <span id="sum-price" class="text-3xl font-bold text-[#16A34A]" style="font-family: 'Space Grotesk', sans-serif;">$0</span>
              </div>
            </div>

            <!-- Trust box -->
            <div class="mt-5 bg-[#1A1A1A] border border-[#2A2A2A] rounded-sm p-3 space-y-2">
              {[
                'üõ°Ô∏è Pago 100% procesado por MercadoPago',
                'üì∏ QC visual antes del env√≠o',
                '‚öñÔ∏è Seguro aduanero incluido',
              ].map(t => (
                <p class="text-[10px] text-[#888888]">{t}</p>
              ))}
            </div>

          </div>
        </div>

      </div>
    </div>
  </main>
</Layout>

<style>
  .input-amg {
    width: 100%;
    background: var(--color-surface-2, #1A1A1A);
    border: 1px solid var(--color-border, #2A2A2A);
    border-radius: 2px;
    padding: 10px 12px;
    font-size: 12px;
    font-weight: 500;
    color: var(--color-text, #F5F5F5);
    outline: none;
    transition: border-color 0.2s;
    font-family: 'Inter', sans-serif;
  }
  .input-amg::placeholder {
    color: var(--color-text-muted, #888888);
    font-size: 11px;
  }
  .input-amg:focus {
    border-color: var(--color-green, #16A34A);
  }
  .input-amg option {
    background: var(--color-surface, #111111);
    color: var(--color-text, #F5F5F5);
  }
</style>

<script>
  import { supabase } from '../lib/supabase';
  import RegionesYComunas from '../data/chile';
  import { cartItems } from '../store/cartStore';
  import type { CartItem } from '../types';

  type CheckoutItem = CartItem & { product_name?: string; image_url?: string };

  const cartStore = cartItems as unknown as {
    subscribe: (callback: (items: CheckoutItem[]) => void) => void;
    get: () => CheckoutItem[];
    set: (items: CheckoutItem[]) => void;
  };

  const listContainer = document.getElementById('checkout-products-list');
  const totalEl       = document.getElementById('sum-price');
  const form          = document.getElementById('checkout-form') as HTMLFormElement;
  const payBtn        = document.getElementById('pay-button') as HTMLButtonElement | null;
  const errorMsg      = document.getElementById('error-message') as HTMLDivElement | null;
  const regionSelect  = document.getElementById('region-select') as HTMLSelectElement;
  const ciudadSelect  = document.getElementById('ciudad-select') as HTMLSelectElement;
  const rutInput      = form?.querySelector('input[name="rut"]') as HTMLInputElement;
  const telefonoInput = form?.querySelector('input[name="telefono"]') as HTMLInputElement;

  function escapeHTML(str: string) { const d = document.createElement('div'); d.textContent = str; return d.innerHTML; }

  function formatRUT(value: string): string {
    const clean = value.replace(/[^0-9K]/gi, '').toUpperCase();
    if (clean.length === 0) return '';
    const dv = clean.slice(-1);
    const nums = clean.slice(0, -1);
    let formatted = '';
    const numReverse = nums.split('').reverse().join('');
    for (let i = 0; i < numReverse.length; i++) {
      if (i > 0 && i % 3 === 0) formatted = '.' + formatted;
      formatted = numReverse[i] + formatted;
    }
    return formatted + '-' + dv;
  }

  function formatPhone(value: string): string {
    let clean = value.replace(/\D/g, '');
    if (clean.startsWith('56')) clean = clean.slice(2);
    if (clean.startsWith('0')) clean = clean.slice(1);
    clean = clean.slice(-9);
    if (clean.length === 0 || !clean.startsWith('9')) return value;
    return `+56${clean}`;
  }

  if (rutInput) {
    rutInput.addEventListener('blur', (e) => {
      const target = e.target as HTMLInputElement;
      let clean = target.value.replace(/[^0-9K]/gi, '').toUpperCase().slice(0, 9);
      if (clean.length > 0) {
        const dv = clean.slice(-1);
        const nums = clean.slice(0, -1);
        let formatted = '';
        const rev = nums.split('').reverse().join('');
        for (let i = 0; i < rev.length; i++) {
          if (i > 0 && i % 3 === 0) formatted = '.' + formatted;
          formatted = rev[i] + formatted;
        }
        target.value = formatted + (dv ? '-' + dv : '');
      }
    });
  }

  if (telefonoInput) {
    telefonoInput.addEventListener('input', (e) => {
      const target = e.target as HTMLInputElement;
      let clean = target.value.replace(/\D/g, '').slice(0, 15);
      if (clean.startsWith('56')) clean = clean.slice(2);
      if (clean.startsWith('0')) clean = clean.slice(1);
      clean = clean.slice(-9);
      if (clean.length > 0 && clean.startsWith('9')) target.value = `+56${clean}`;
      else if (clean.length > 0) target.value = clean;
    });
  }

  cartStore.subscribe((items: CheckoutItem[]) => {
    if (!listContainer || !totalEl) return;
    if (items.length === 0) {
      listContainer.innerHTML = `<p class="text-center text-xs text-[#888888] py-8 uppercase tracking-widest">Carrito vac√≠o</p>`;
      totalEl.textContent = '$0';
      if (payBtn) payBtn.disabled = true;
      return;
    }
    if (payBtn) payBtn.disabled = false;
    listContainer.innerHTML = items.map((item) => {
      const nombre  = escapeHTML(item.name || item.product_name || 'Producto AMG');
      const imagen  = escapeHTML(item.image || item.image_url || '/placeholder.jpg');
      const talla   = escapeHTML(String(item.size || 'N/A'));
      const calidad = escapeHTML(String(item.quality || 'PK'));
      const precio  = Number(item.price) || 0;
      const cantidad = Number(item.quantity) || 1;
      return `
        <div class="flex gap-3 bg-[#1A1A1A] border border-[#2A2A2A] rounded-sm p-3 items-center">
          <img src="${imagen}" class="w-14 h-14 object-contain bg-[#1A1A1A] rounded-sm flex-shrink-0" alt="${nombre}" />
          <div class="flex-1 min-w-0">
            <p class="font-semibold text-[11px] text-[#F5F5F5] truncate">${nombre}</p>
            <div class="flex gap-1.5 mt-1">
              <span class="text-[9px] font-bold bg-[#2A2A2A] text-[#888888] px-2 py-0.5 rounded-sm">EU ${talla}</span>
              <span class="text-[9px] font-bold bg-[#16A34A] text-black px-2 py-0.5 rounded-sm">${calidad}</span>
            </div>
          </div>
          <p class="font-bold text-xs text-[#16A34A] flex-shrink-0">$${(precio * cantidad).toLocaleString('es-CL')}</p>
        </div>
      `;
    }).join('');
    const total = items.reduce((acc, item) => acc + ((Number(item.price) || 0) * (Number(item.quantity) || 1)), 0);
    totalEl.textContent = `$${total.toLocaleString('es-CL')}`;
  });

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (payBtn) { payBtn.disabled = true; payBtn.textContent = 'Procesando...'; }
    if (errorMsg) errorMsg.classList.add('hidden');

    try {
      const formData = new FormData(form);
      const currentItems = cartStore.get();
      if (!currentItems || currentItems.length === 0) throw new Error('Carrito vac√≠o');
      if (currentItems.some(item => !item.id || !item.name || !item.price || (item.quantity || 0) < 1)) throw new Error('Carrito inv√°lido');

      const { data: { session } } = await supabase.auth.getSession();
      const userId = session?.user?.id || null;

      const rut         = (formData.get('rut') as string).trim();
      const phone       = (formData.get('telefono') as string).trim();
      const formattedRut   = formatRUT(rut);
      const formattedPhone = formatPhone(phone);
      const firstName   = (formData.get('primer_nombre') as string).trim();
      const lastName    = (formData.get('apellido_paterno') as string).trim();
      const email       = (formData.get('email') as string).trim().toLowerCase();
      const region      = String(formData.get('region') || '').trim();
      const city        = String(formData.get('ciudad') || '').trim();
      const address     = (formData.get('direccion') as string).trim();

      if (!firstName || !lastName || !email || !address) throw new Error('Completa todos los campos obligatorios');
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email))   throw new Error('Email inv√°lido');
      if (!/^\d{1,2}\.\d{3}\.\d{3}-[0-9K]$/i.test(formattedRut))   throw new Error('RUT inv√°lido');
      if (!/^\+56\d{9}$/.test(formattedPhone)) throw new Error('Tel√©fono inv√°lido');
      if (!region || !city) throw new Error('Selecciona regi√≥n y comuna');

      const payload = {
        items: currentItems,
        customer: { userId, firstName, lastName, email, rut: formattedRut, phone: formattedPhone, region, city, address },
      };

      const response = await fetch('/api/create-payment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const result = await response.json();

      if (!response.ok) {
        if (response.status === 429) {
          const retryAfter = response.headers.get('Retry-After') || result.retryAfter;
          throw new Error(`Demasiados intentos. Espera ${Math.ceil(retryAfter / 60)} minutos.`);
        }
        throw new Error(result.error || `Error ${response.status}`);
      }

      if (!result.init_point) throw new Error('No se pudo generar el enlace de pago');

      window.location.href = result.init_point;

    } catch (err: unknown) {
      const message = err instanceof Error ? err.message : 'Error desconocido';
      if (errorMsg) { errorMsg.textContent = `‚ö†Ô∏è ${message}`; errorMsg.classList.remove('hidden'); }
    } finally {
      if (payBtn) { payBtn.disabled = false; payBtn.textContent = 'Pagar de forma segura en MercadoPago üîí'; }
    }
  });

  regionSelect?.addEventListener('change', () => {
    const reg = RegionesYComunas.find(r => r.name === regionSelect.value);
    if (ciudadSelect && reg) {
      ciudadSelect.innerHTML = '<option value="" disabled selected>Seleccionar comuna</option>';
      ciudadSelect.disabled = false;
      reg.communes.sort().forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        ciudadSelect.appendChild(opt);
      });
    }
  });
</script>