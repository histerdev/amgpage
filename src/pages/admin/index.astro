---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Panel Admin | AMG">
  <main class="max-w-7xl mx-auto px-6 py-12">

    <div id="status-message" class="text-center py-20 font-black uppercase italic tracking-tighter text-xl">
      Verificando acceso...
    </div>

    <div id="admin-content" class="hidden">
      <div class="flex justify-between items-end mb-10">
        <h1 class="text-5xl font-[900] italic uppercase tracking-tighter text-black">GestiÃ³n de Pedidos</h1>
        <p class="text-xs font-bold text-gray-400 uppercase tracking-widest pb-2">AMG Sneakers Admin v1.1</p>
      </div>

      <div class="bg-white rounded-[32px] shadow-xl border border-gray-100 overflow-hidden">
        <table class="w-full text-left border-collapse">
          <thead>
            <tr class="bg-gray-50 border-b border-gray-100">
              <th class="p-6 text-[10px] font-black uppercase tracking-widest text-gray-400">Pedido / Cliente</th>
              <th class="p-6 text-[10px] font-black uppercase tracking-widest text-gray-400">Producto</th>
              <th class="p-6 text-[10px] font-black uppercase tracking-widest text-gray-400">Estado LogÃ­stico</th>
              <th class="p-6 text-[10px] font-black uppercase tracking-widest text-gray-400 text-center">ElecciÃ³n Cliente</th>
              <th class="p-6 text-[10px] font-black uppercase tracking-widest text-gray-400 text-right">AcciÃ³n</th>
            </tr>
          </thead>
          <tbody id="admin-orders-list"></tbody>
        </table>
      </div>
    </div>

  </main>
</Layout>

<script>
  import { supabase } from '../../lib/supabase';
  import { waitForSession } from '../../lib/auth';

  async function checkAccess() {
    const status  = document.getElementById('status-message');
    const content = document.getElementById('admin-content');
    const list    = document.getElementById('admin-orders-list');

    const escapeHTML = (value: unknown) => {
      const div = document.createElement('div');
      div.textContent = String(value ?? '');
      return div.innerHTML;
    };

    // â”€â”€ 1. Esperar sesiÃ³n real (resuelve el race condition) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const session = await waitForSession();

    if (!session) {
      window.location.replace('/login?redirectTo=/admin');
      return;
    }

    // â”€â”€ 2. Verificar rol admin â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const { data: profile } = await supabase
      .from('profiles')
      .select('role')
      .eq('id', session.user.id)
      .single();

    if (profile?.role !== 'admin') {
      if (status) status.textContent = `ğŸš« ACCESO DENEGADO. Tu rol es: ${profile?.role ?? 'sin rol'}`;
      return;
    }

    // â”€â”€ 3. Cargar pedidos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const { data: orders, error: ordersError } = await supabase
      .from('orders')
      .select(`*, order_items (*)`)
      .order('created_at', { ascending: false });

    if (ordersError) {
      if (status) status.innerText = `âš ï¸ Error al cargar pedidos: ${ordersError.message}`;
      return;
    }

    // â”€â”€ 4. Mostrar contenido â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    status?.classList.add('hidden');
    content?.classList.remove('hidden');

    if (!list || !orders) return;

    if (orders.length === 0) {
      list.innerHTML = `<tr><td colspan="5" class="p-20 text-center font-bold text-gray-300 uppercase italic">No hay pedidos registrados aÃºn</td></tr>`;
      return;
    }

    const decisionHtml = (decision: string) => {
      if (decision === 'Reembolso')
        return `<span class="bg-red-600 text-white px-3 py-1.5 rounded-xl text-[9px] font-black uppercase italic animate-pulse">âš ï¸ Reembolso</span>`;
      if (decision === 'Confirmado')
        return `<span class="bg-[#2ecc71] text-black px-3 py-1.5 rounded-xl text-[9px] font-black uppercase italic">âœ… Confirmado</span>`;
      if (decision === 'Cambio de par')
        return `<span class="bg-blue-600 text-white px-3 py-1.5 rounded-xl text-[9px] font-black uppercase italic">ğŸ”„ Cambio Par</span>`;
      return `<span class="text-gray-300 text-[9px] font-bold uppercase italic tracking-widest">Pendiente</span>`;
    };

    list.innerHTML = orders.map((order: any) => {
      const item = order.order_items?.[0] || {};
      const safeCustomer = escapeHTML(order.customer_name || 'Sin nombre');
      const safeOrderId = escapeHTML(String(order.id || ''));
      const safeOrderIdShort = escapeHTML(String(order.id || '').slice(0, 8));
      const safeProduct = escapeHTML(item.product_name || 'Desconocido');
      const safeSize = escapeHTML(item.size || '--');
      const safeStatus = escapeHTML(order.status || '');
      const safeDecision = decisionHtml(order.client_decision);
      const safeHrefId = encodeURIComponent(String(order.id || ''));

      return `
        <tr class="border-b border-gray-50 hover:bg-gray-50/50 transition-all">
          <td class="p-6">
            <div class="font-black uppercase italic text-sm">${safeCustomer}</div>
            <div class="text-[10px] text-gray-400 font-bold tracking-tighter">${safeOrderIdShort || safeOrderId}</div>
          </td>
          <td class="p-6">
            <div class="text-[11px] font-bold uppercase text-gray-600">${safeProduct}</div>
            <div class="text-[9px] font-black text-gray-400 uppercase">Talla: ${safeSize}</div>
          </td>
          <td class="p-6 text-center">
            <span class="bg-black text-white px-3 py-1 rounded-full text-[9px] font-black uppercase tracking-tighter">
              ${safeStatus}
            </span>
          </td>
          <td class="p-6 text-center">
            ${safeDecision}
          </td>
          <td class="p-6 text-right">
            <button
              onclick="window.location.href='/admin/pedido/${safeHrefId}'"
              class="bg-[#2ecc71] hover:bg-black text-white px-5 py-2.5 rounded-2xl text-[10px] font-black uppercase italic transition-all active:scale-95"
            >
              Gestionar QC
            </button>
          </td>
        </tr>
      `;
    }).join('');
  }

  checkAccess();
</script>