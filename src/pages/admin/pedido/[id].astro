---
import Layout from '../../../layouts/Layout.astro';
import { createSupabaseServerClient } from '../../../lib/supabase-ssr';

export const prerender = false;
const { id } = Astro.params;
if (!id) return Astro.redirect('/admin');

// SECURITY FIX: Server-side admin verification (defence-in-depth beyond middleware)
// The middleware's startsWith("/admin") guard covers this route, but an explicit
// server-side check here ensures this page is NEVER rendered for non-admins even
// if middleware logic changes in the future.
const _responseHeaders = new Headers();
const _supabase = createSupabaseServerClient(Astro.request, _responseHeaders);
const { data: { user: _user } } = await _supabase.auth.getUser();
if (!_user) return Astro.redirect('/login?redirectTo=/admin');
const { data: _profile } = await _supabase
  .from('profiles')
  .select('role')
  .eq('id', _user.id)
  .single();
if (_profile?.role !== 'admin') {
  return new Response('403 Forbidden — Admin access only.', { status: 403 });
}
---

<Layout title={`Gestión Pedido #${id?.slice(0,5)}`}>
  <main class="max-w-6xl mx-auto px-6 py-12 font-['Inter'] text-black">
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-4xl font-[900] italic uppercase tracking-tighter">Control de Calidad (QC)</h1>
        <a href="/admin" class="text-[10px] font-black uppercase bg-gray-100 px-4 py-2 rounded-full hover:bg-black hover:text-white transition-all">Volver</a>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <div class="lg:col-span-2 space-y-6" id="products-container">
          <p class="font-black uppercase text-gray-400">Cargando expediente...</p>
      </div>

      <div class="space-y-6">
        <div class="bg-black text-white p-8 rounded-[32px] sticky top-8 shadow-2xl">
            <label class="block text-[10px] font-black uppercase text-zinc-500 mb-2">Estado General</label>
            <select id="global-status" class="w-full bg-zinc-900 border border-zinc-800 rounded-xl p-4 mb-6 text-white font-bold outline-none">
                <option value="Procesando">Procesando</option>
                <option value="Esperando QC">Esperando QC</option>
                <option value="QC Listo">QC Listo</option>
                <option value="Enviado">Enviado</option>
            </select>
            <button id="save-all-btn" class="w-full bg-[#2ecc71] text-black py-5 rounded-2xl font-[900] uppercase italic tracking-widest hover:brightness-110">
                Actualizar Pedido
            </button>
        </div>
      </div>
    </div>
  </main>
</Layout>

<script>
  import { supabase } from '../../../lib/supabase';

  // Definimos la estructura del item para TypeScript
  interface OrderItem {
    id: string;
    product_name: string;
    image_url: string;
    qc_images: string[] | null;
    item_notes: string | null;
    size: string;
    quality: string;
  }

  const orderId = window.location.pathname.split('/').pop() || '';
  let itemsData: OrderItem[] = [];

  const escapeHTML = (value: unknown) => {
    const div = document.createElement('div');
    div.textContent = String(value ?? '');
    return div.innerHTML;
  };

  const MAX_FILES_PER_ITEM = 8;
  const MAX_FILE_SIZE_MB = 20;
  const ALLOWED_MIME_TYPES = new Set([
    'image/jpeg',
    'image/png',
    'image/webp',
    'image/avif',
  ]);

  async function loadData() {
    const { data, error } = await supabase.from('orders').select('*, order_items(*)').eq('id', orderId).single();
    if (error || !data) return;
    
    itemsData = data.order_items;
    const container = document.getElementById('products-container');
    const statusSelect = document.getElementById('global-status') as HTMLSelectElement;
    if (statusSelect) statusSelect.value = data.status;

    if (container) {
        container.innerHTML = itemsData.map((item: OrderItem) => {
            const safeId = escapeHTML(item.id);
            const safeImage = escapeHTML(item.image_url);
            const safeName = escapeHTML(item.product_name);
            const safeNotes = escapeHTML(item.item_notes || '');
            const safeImages = (item.qc_images || []).map((url: string) => {
              const safeUrl = escapeHTML(url);
              return `<img src="${safeUrl}" class="w-12 h-12 rounded object-cover border" />`;
            }).join('');

            return `
            <div class="bg-white border-2 border-black rounded-[32px] overflow-hidden product-card" data-item-id="${safeId}">
                <div class="p-6 grid md:grid-cols-2 gap-6">
                    <div>
                        <img src="${safeImage}" class="w-full aspect-square object-contain bg-gray-50 rounded-2xl mb-2" />
                        <h3 class="font-black uppercase italic text-lg leading-tight">${safeName}</h3>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-[9px] font-black uppercase text-gray-400 mb-1">Subir Fotos QC</label>
                            <input type="file" multiple accept="image/*" class="qc-input text-[10px]" />
                        </div>
                        <div class="flex gap-1 flex-wrap">
                            ${safeImages}
                        </div>
                        <div>
                            <label class="block text-[9px] font-black uppercase text-gray-400 mb-1">Nota del Par</label>
                            <textarea class="item-notes w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-xs" rows="3">${safeNotes}</textarea>
                        </div>
                    </div>
                </div>
            </div>
        `;
        }).join('');
    }
  }
document.getElementById('save-all-btn')?.addEventListener('click', async () => {
    const btn = document.getElementById('save-all-btn') as HTMLButtonElement;
    btn.innerText = "SUBIENDO ARCHIVOS...";
    btn.disabled = true;

    try {
        // 1. Estado Global
        const status = (document.getElementById('global-status') as HTMLSelectElement).value;
        await supabase.from('orders').update({ status }).eq('id', orderId);

        // 2. Procesar Items
        const cards = document.querySelectorAll('.product-card');
        
        for (const card of cards) {
            const itemId = card.getAttribute('data-item-id');
            const notes = (card.querySelector('.item-notes') as HTMLTextAreaElement).value;
            const fileInput = card.querySelector('.qc-input') as HTMLInputElement;
            
            const newUploadedUrls: string[] = [];

            // --- LÓGICA DE SUBIDA CRÍTICA (VALIDADA) ---
            if (fileInput && fileInput.files && fileInput.files.length > 0) {
                const files = Array.from(fileInput.files).slice(0, MAX_FILES_PER_ITEM);
                
                for (const file of files) {
                    const isAllowedType = ALLOWED_MIME_TYPES.has(file.type);
                    const isAllowedSize = file.size <= MAX_FILE_SIZE_MB * 1024 * 1024;

                    if (!isAllowedType || !isAllowedSize) {
                        console.warn(`Archivo inválido: ${file.name}`);
                        continue;
                    }

                    const fileExt = file.name.split('.').pop() || 'jpg';
                    const unique = `${Date.now()}-${Math.random().toString(36).slice(2, 10)}`;
                    const filePath = `${itemId}/${unique}.${fileExt}`;

                    const { data: uploadData, error: uploadError } = await supabase.storage
                        .from('qc-media')
                        .upload(filePath, file, {
                            cacheControl: '3600',
                            upsert: false
                        });

                    if (uploadError) {
                        console.error("Error subiendo archivo:", uploadError.message);
                        continue;
                    }

                    if (uploadData) {
                        const { data: { publicUrl } } = supabase.storage
                            .from('qc-media')
                            .getPublicUrl(filePath);
                        newUploadedUrls.push(publicUrl);
                    }
                }
            }

            // 3. Obtener imágenes previas para no borrarlas
            const currentItem = itemsData.find(i => i.id === itemId);
            const existingImages = currentItem?.qc_images || [];
            
            // Combinamos las fotos que ya estaban con las nuevas
            const finalImagesArray = [...existingImages, ...newUploadedUrls];

            // 4. ACTUALIZACIÓN EN BASE DE DATOS
            const { error: updateError } = await supabase
                .from('order_items')
                .update({ 
                    item_notes: notes, 
                    qc_images: finalImagesArray 
                })
                .eq('id', itemId);

            if (updateError) {
                console.error("Error actualizando DB:", updateError.message);
            }
        }

        alert("¡Todo actualizado! Fotos y mensajes guardados.");
        location.reload();

    } catch (err) {
        console.error("Error general:", err);
        alert("Ocurrió un error inesperado.");
    } finally {
        btn.innerText = "Actualizar Pedido";
        btn.disabled = false;
    }
})

  loadData();
</script>