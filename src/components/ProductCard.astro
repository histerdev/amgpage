---
interface Props {
  id: string;
  name: string;
  prices: { PK: number; G5: number };
  image: string | string[];
  tags: string[];
  tallas?: string[];
}

const { id, name, prices, image, tags = [] } = Astro.props;
const productUrl = `/producto/${id}`;
const mainImage = Array.isArray(image) ? image[0] : image;

// Show lowest price
const lowestPrice = Math.min(prices.PK, prices.G5);
const displayPrice = new Intl.NumberFormat('es-CL').format(lowestPrice);
const tagsData = tags.map(t => t.toLowerCase()).join('|');

// Determine grade badge
const hasPK = prices.PK && prices.PK > 0;
---

<article
  class="group relative bg-[#111111] border border-[#2A2A2A] rounded-[2px] overflow-hidden flex flex-col h-full product-item transition-all duration-200"
  data-name={name.toLowerCase()}
  data-tags={tagsData}
>
  <!-- Grade badge -->
  {hasPK && (
    <div class="absolute top-3 right-3 z-20">
      <span class="bg-[#16A34A] text-black text-[9px] font-bold uppercase tracking-wider px-2.5 py-1 rounded-full">
        PK
      </span>
    </div>
  )}

  <!-- Tags (top left) -->
  <div class="absolute top-3 left-3 z-20 flex flex-wrap gap-1 max-w-[65%]">
    {tags.slice(0, 2).map((t) => (
      <span class="bg-[#0A0A0A]/80 backdrop-blur-sm text-[#888888] text-[9px] font-semibold uppercase px-2 py-0.5 rounded-sm tracking-wider">
        {t}
      </span>
    ))}
  </div>

  <!-- ❤ Wishlist heart button -->
  <button
    class="wishlist-heart-btn absolute bottom-[calc(100%-48px)] right-3 z-30 w-8 h-8 rounded-full bg-black/60 backdrop-blur-sm border border-[#2A2A2A] flex items-center justify-center transition-all duration-200 hover:scale-110 hover:border-red-400/60"
    data-product-id={id}
    data-product-name={name}
    data-product-image={mainImage}
    data-price-pk={prices.PK}
    data-price-g5={prices.G5}
    aria-label="Guardar par"
    title="Guardar par"
    style="top: 40px;"
  >
    <!-- Outline heart (default) -->
    <svg class="heart-outline w-4 h-4 text-[#888888] transition-all" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
    </svg>
    <!-- Filled heart (wishlisted) -->
    <svg class="heart-filled w-4 h-4 text-red-400 hidden transition-all" fill="currentColor" viewBox="0 0 24 24">
      <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
    </svg>
  </button>

  <!-- Image -->
  <a href={productUrl} class="aspect-square overflow-hidden bg-[#1A1A1A] flex items-center justify-center p-8 relative cursor-pointer block">
    <img
      src={mainImage}
      alt={`${name} — AMG Sneakers Chile`}
      class="w-full h-full object-contain transition-transform duration-500 group-hover:scale-[1.04] z-10"
      loading="lazy"
      width={640}
      height={640}
    />
  </a>

  <!-- Details -->
  <div class="p-5 flex flex-col flex-grow border-t border-[#2A2A2A]">
    <!-- Availability -->
    <div class="flex items-center gap-1.5 mb-2">
      <span class="w-1.5 h-1.5 rounded-full bg-[#16A34A] animate-pulse flex-shrink-0"></span>
      <span class="text-[9px] font-semibold text-[#888888] uppercase tracking-widest">Disponible</span>
    </div>

    <!-- Name -->
    <a href={productUrl}>
      <h2 class="text-sm font-semibold text-[#F5F5F5] leading-snug mb-3 group-hover:text-[#22C55E] transition-colors duration-200 line-clamp-2">
        {name}
      </h2>
    </a>

    <!-- Price + CTA -->
    <div class="mt-auto space-y-3">
      <div>
        <p class="text-xl font-bold text-[#16A34A]">
          ${displayPrice}
        </p>
        <p class="text-[10px] text-[#888888] uppercase tracking-wider">Precio de Gestión</p>
      </div>

      <a
        href={productUrl}
        class="flex items-center justify-center gap-1.5 w-full py-3 border border-[#2A2A2A] text-[#F5F5F5] text-[11px] font-semibold uppercase tracking-wider hover:border-[#16A34A] hover:text-[#16A34A] transition-all duration-200 rounded-sm"
      >
        Ver Par
        <svg class="card-arrow w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
          <path d="M9 18l6-6-6-6" />
        </svg>
      </a>
    </div>
  </div>
</article>

<script>
  import { wishlist, toggleWishlist, isWishlisted } from '../store/wishlistStore';

  function syncAllHearts() {
    document.querySelectorAll<HTMLElement>('.wishlist-heart-btn').forEach(btn => {
      const id = btn.dataset.productId!;
      const saved = isWishlisted(id);
      btn.querySelector('.heart-outline')?.classList.toggle('hidden', saved);
      btn.querySelector('.heart-filled')?.classList.toggle('hidden', !saved);
    });
  }

  // Initial sync
  syncAllHearts();

  // Re-sync when wishlist changes
  wishlist.subscribe(() => syncAllHearts());
  window.addEventListener('wishlist-change', () => syncAllHearts());

  // Bind clicks — use event delegation on document since cards may be re-rendered
  document.addEventListener('click', async (e) => {
    const btn = (e.target as HTMLElement).closest<HTMLElement>('.wishlist-heart-btn');
    if (!btn) return;
    e.preventDefault();
    e.stopPropagation();

    const id    = btn.dataset.productId!;
    const name  = btn.dataset.productName!;
    const image = btn.dataset.productImage!;
    const pricePK = Number(btn.dataset.pricePk);
    const priceG5 = Number(btn.dataset.priceG5);

    // Optimistic toggle animation
    const outline = btn.querySelector('.heart-outline') as SVGElement;
    const filled  = btn.querySelector('.heart-filled') as SVGElement;
    const currentlySaved = !outline.classList.contains('hidden') === false;

    const wasSaved = isWishlisted(id);

    // Animate
    btn.style.transform = 'scale(1.25)';
    setTimeout(() => { btn.style.transform = ''; }, 200);

    const nowSaved = await toggleWishlist({ id, name, image, pricePK, priceG5, savedAt: Date.now() });

    outline?.classList.toggle('hidden', nowSaved);
    filled?.classList.toggle('hidden', !nowSaved);

    // Show micro-toast
    showWishlistToast(nowSaved, name);

    window.dispatchEvent(new CustomEvent('wishlist-change', { detail: { id, saved: nowSaved } }));
  });

  function showWishlistToast(saved: boolean, name: string) {
    const existing = document.getElementById('wl-toast');
    existing?.remove();

    const toast = document.createElement('div');
    toast.id = 'wl-toast';
    toast.className = 'fixed bottom-[80px] left-4 z-[200] flex items-center gap-2.5 bg-[#1A1A1A] border border-[#2A2A2A] rounded-sm px-4 py-3 shadow-2xl max-w-[280px]';
    toast.style.cssText = 'opacity:0; transform:translateX(-16px); transition: opacity 0.3s ease, transform 0.3s ease;';

    const shortName = name.length > 28 ? name.slice(0, 28) + '…' : name;
    toast.innerHTML = saved
      ? `<svg class="w-4 h-4 text-red-400 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg><div><p class="text-[11px] text-[#F5F5F5] font-semibold">${shortName}</p><a href="/guardados" class="text-[10px] text-[#16A34A] hover:underline">Ver guardados →</a></div>`
      : `<svg class="w-4 h-4 text-[#888888] flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg><p class="text-[11px] text-[#888888]">Quitado de guardados</p>`;

    document.body.appendChild(toast);
    requestAnimationFrame(() => requestAnimationFrame(() => {
      toast.style.opacity = '1';
      toast.style.transform = 'translateX(0)';
    }));
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateX(-16px)';
      setTimeout(() => toast.remove(), 350);
    }, 3500);
  }
</script>