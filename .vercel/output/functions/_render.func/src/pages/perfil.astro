---
import Layout from '../layouts/Layout.astro';

export const prerender = false;
---

<Layout title="Mi Perfil | Store">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    
    
    <main class="max-w-6xl mx-auto px-6 py-12 md:py-24 font-['Inter',_sans-serif]">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
            
            <div class="lg:col-span-4 space-y-8">
                <div class="bg-black text-white p-10 rounded-[40px] shadow-2xl relative overflow-hidden group">
                    <div class="relative z-10">
                        <div class="w-20 h-20 bg-zinc-800 rounded-2xl flex items-center justify-center text-3xl font-black mb-6 border border-zinc-700 uppercase" id="user-initial">
                            --
                        </div>
                        <h2 id="profile-email" class="text-sm font-bold opacity-60 tracking-widest uppercase mb-1">Cargando...</h2>
                        <p class="text-2xl font-[900] italic tracking-tighter leading-none mb-6">MIEMBRO EXCLUSIVO</p>
                        
                        <button id="logout-btn" class="text-[10px] font-black uppercase tracking-[0.2em] bg-white text-black px-6 py-3 rounded-full hover:bg-zinc-200 transition-colors">
                            Cerrar Sesión
                        </button>
                    </div>
                    <div class="absolute -right-10 -bottom-10 text-[120px] font-[900] italic text-zinc-900 select-none pointer-events-none">
                        QC
                    </div>
                </div>

                <div class="bg-zinc-50 p-8 rounded-[40px] border border-zinc-100">
                    <h3 class="text-[11px] font-black uppercase tracking-[0.2em] text-zinc-400 mb-6">Estadísticas</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white p-4 rounded-2xl shadow-sm border border-zinc-100">
                            <p class="text-[9px] font-black text-zinc-400 uppercase tracking-widest">Pedidos</p>
                            <p id="stats-orders" class="text-2xl font-[900] italic">0</p>
                        </div>
                        <div class="bg-white p-4 rounded-2xl shadow-sm border border-zinc-100">
                            <p class="text-[9px] font-black text-zinc-400 uppercase tracking-widest">Inversión</p>
                            <p id="stats-total" class="text-lg font-[900] italic leading-tight mt-1">$0</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-8 space-y-8">
                <div class="flex items-end justify-between px-2">
                    <h3 class="text-4xl font-[900] uppercase italic tracking-tighter leading-none">Historial de Pedidos</h3>
                </div>

                <div id="orders-container" class="space-y-4">
                    <div id="loading-state" class="p-20 text-center text-zinc-400 font-black uppercase tracking-widest animate-pulse">
                        Sincronizando con base de datos...
                    </div>
                </div>
            </div>

        </div>
    </main>
</Layout>

<style>
    #orders-container::-webkit-scrollbar { width: 4px; }
    #orders-container::-webkit-scrollbar-thumb { background: #e4e4e7; border-radius: 10px; }
</style>

<script>
    import { supabase } from '../lib/supabase';
    import { waitForSession } from '../lib/auth';

    const ordersContainer = document.getElementById('orders-container');
    const loadingState    = document.getElementById('loading-state');
    const logoutBtn       = document.getElementById('logout-btn');

    async function loadProfile() {
        // Espera a que la sesión esté realmente disponible
        const session = await waitForSession();

        if (!session) {
            window.location.replace('/login');
            return;
        }

        // Mostrar datos básicos
        const emailEl   = document.getElementById('profile-email');
        const initialEl = document.getElementById('user-initial');
        if (emailEl)   emailEl.innerText   = session.user.email || '';
        if (initialEl) initialEl.innerText = (session.user.user_metadata?.full_name || session.user.email || 'U').charAt(0).toUpperCase();

        // Traer pedidos
        const { data: orders, error } = await supabase
            .from('orders')
            .select(`*, order_items (*)`)
            .eq('user_id', session.user.id)
            .order('created_at', { ascending: false });

        if (error) {
            console.error(error);
            if (loadingState) loadingState.innerText = '⚠️ Error al cargar pedidos';
            return;
        }

        // Estadísticas
        const totalSpent = orders.reduce((acc: number, curr: any) => acc + (curr.total_price || 0), 0);
        const statsOrders = document.getElementById('stats-orders');
        const statsTotal  = document.getElementById('stats-total');
        if (statsOrders) statsOrders.innerText = orders.length.toString();
        if (statsTotal)  statsTotal.innerText  = `$${new Intl.NumberFormat('es-CL').format(totalSpent)}`;

        // Renderizar pedidos
        if (loadingState) loadingState.remove();

        if (orders.length === 0) {
            ordersContainer!.innerHTML = `
                <div class="bg-zinc-50 p-16 rounded-[40px] text-center border-2 border-dashed border-zinc-200">
                    <p class="text-[11px] font-black uppercase tracking-widest text-zinc-400">Aún no tienes pedidos registrados</p>
                </div>
            `;
            return;
        }

        const statusColors: Record<string, string> = {
            'Pendiente de Pago': 'bg-amber-100 text-amber-700',
            'Pagado':            'bg-green-100 text-green-700',
            'Enviado':           'bg-blue-100 text-blue-700',
        };

        orders.forEach((order: any) => {
            const date = new Date(order.created_at).toLocaleDateString('es-CL', { day: 'numeric', month: 'short', year: 'numeric' });
            const item = order.order_items[0];

            const card = document.createElement('div');
            card.className = "group bg-white border border-zinc-100 p-6 rounded-[32px] flex flex-col md:flex-row items-center gap-6 transition-all hover:shadow-xl hover:shadow-zinc-200/50 hover:border-zinc-200";

            card.innerHTML = `
                <div class="w-24 h-24 bg-zinc-50 rounded-2xl flex-shrink-0 flex items-center justify-center p-2 border border-zinc-100">
                    <img src="${item?.image_url || ''}" class="w-full h-full object-contain mix-blend-multiply" alt="Producto">
                </div>
                <div class="flex-1 text-center md:text-left space-y-1">
                    <div class="flex flex-col md:flex-row md:items-center gap-2">
                        <span class="text-[10px] font-black text-zinc-400 uppercase tracking-widest">${date}</span>
                        <span class="text-[9px] px-3 py-1 rounded-full font-black uppercase tracking-widest ${statusColors[order.status] || 'bg-zinc-100 text-zinc-600'} w-fit mx-auto md:mx-0">
                            ${order.status}
                        </span>
                    </div>
                    <h4 class="text-xl font-[900] uppercase italic tracking-tighter leading-none">${item?.product_name || 'Pedido Sin Nombre'}</h4>
                    <p class="text-[10px] text-zinc-400 font-bold uppercase tracking-widest">
                        Talla: ${item?.size || '--'} | Calidad: ${item?.quality || '--'}
                    </p>
                </div>
                <div class="text-center md:text-right">
                    <p class="text-2xl font-[900] italic tracking-tighter">$${new Intl.NumberFormat('es-CL').format(order.total_price)}</p>
                    <p class="text-[9px] font-black text-zinc-300 uppercase tracking-widest">ID: ${order.id.slice(0, 8)}</p>
                </div>
            `;
            ordersContainer!.appendChild(card);
        });
    }

    logoutBtn?.addEventListener('click', async () => {
        await supabase.auth.signOut();
        window.location.replace('/login');
    });

    loadProfile();
</script>